---
title: "enterobranches vs time-series"
output: html_notebook
---




```{r}

library(dplyr)
library(ggplot2)
devtools::load_all(reset = FALSE)




```


```{r}


enterotypes = readr::read_csv2("enterotypes_prediction_outliers.csv")[,-1]

metadata=read.csv2(system.file("data-raw/Metadata_10317_20191022-112414_curatedv4_VSv1.csv", package = "gutzilla"), stringsAsFactors = FALSE) %>% mutate_all(na_if,"")

shannon_path = system.file("data-raw/qiime/generated-files-20190512/alpha/shannon.qza", package = "gutzilla")

shannon = qiime2R::read_qza(shannon_path)$data %>% as.data.frame

```

```{r}

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_date()) %>%
  group_by(HOST_SUBJECT_ID) %>%
  summarise(n=n()) %>%
  filter(n>1) %>%
  pull(n) %>% table



metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_date()) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  mutate(sample_order=rank(days)) %>% 
  ggplot() + geom_line(aes(x=days,y=sample_order, group=HOST_SUBJECT_ID)) + scale_y_log10()



```



```{r}

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_date()) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  mutate(sample_order=rank(days)) %>% 
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  mutate(sample_order=rank(days)) %>% 
  xtabs(~ branches + HOST_SUBJECT_ID, data=.) %>%
  as.data.frame %>%
  filter(Freq!=0)



metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_date()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>% 
  arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>% 
  filter(any(days==0)) %>% 
  filter(sample_order>1 & days <25) %>% 
  ggplot() + geom_tile(aes(x=sample_order,y=HOST_SUBJECT_ID, fill=branches)) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) + facet_wrap(~days_0, scales="free_y")




```


```{r}

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_date()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>% 
  arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  ggplot() + geom_point(aes(x=days +1,y=HOST_SUBJECT_ID, col=branches), shape=15) +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank()) + facet_wrap(~days_0, scales="free_y") + scale_x_log10()
 

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_date()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>% 
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  filter(days > 0, days<365) %>%
  ungroup() %>%
  select(days_0,branches) %>% 
  xtabs(~days_0+branches, data=.) %>% prop.table(1)





```






```{r}

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_date()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>% 
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(HOST_SUBJECT_ID, days, sample_order, branches) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(same_branches_lag = ifelse(branches == lag(branches), "yes","no"), branches_before=lag(branches), days_delta= days - lag(days)) %>% 
  filter(sample_order >1) %>%
  mutate(branches_pairs=paste0(branches_before,"-",branches)) %>%
  ggplot() + geom_boxplot(aes(x=branches_pairs, y=days_delta+1)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ 
  scale_y_log10() + facet_wrap(~branches_before, scales = "free", nrow=1)




```



```{r}


metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  
  filter(days == 0 | days > 60*60*24) %>%
  
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>% 
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(HOST_SUBJECT_ID, days, sample_order, branches) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(same_branches_lag = ifelse(branches == lag(branches), "yes","no"), branches_before=lag(branches), days_delta= days - lag(days)) %>% 
  filter(sample_order >1) %>%
  mutate(branches_pairs=paste0(branches_before,"-",branches)) %>%
  mutate(days_delta_bins = cut(days_delta, breaks = c(-1,60*60*24*7,120*24*60*60,365*60*60*24,10000*60*60*24))) %>%
  ggplot() + geom_bar(aes(x=days_delta_bins, fill=branches), position="fill") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_y_continuous(labels = scales::percent) + scale_fill_brewer("branches after", type="qual") +
  facet_wrap(~branches_before) + xlab("time range between two samples") + ylab("Samples %") + scale_x_discrete(labels=c("week","4 months", "4 to 12 months", "> 12 months")) -> figS9A

figS9A


ggsave("FigS9A_branche_before_after.pdf")

```
## compute prevotella bacteroides ratio within days
```{r}


genus_path = system.file("data-raw/qiime/generated-files-20190512/taxa/genus.qza", package = "gutzilla")
genus = qiime2R::read_qza(genus_path)$data %>% as.data.frame %>% tibble::rownames_to_column("taxa")  %>% as_tibble()

genus %>% 
  filter(taxa %in% c("k__Bacteria;p__Bacteroidetes;c__Bacteroidia;o__Bacteroidales;f__Bacteroidaceae;g__Bacteroides",
                     "k__Bacteria;p__Bacteroidetes;c__Bacteroidia;o__Bacteroidales;f__Prevotellaceae;g__Prevotella")) %>%
  tibble::column_to_rownames("taxa") %>%
  t() %>%
  as.data.frame() -> TS_agp_genus_P_B


metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME,days, COLLECTION_TIMESTAMP) -> host_sample_days


host_sample_days %>%
  merge(host_sample_days, by="HOST_SUBJECT_ID") %>%
  filter(!(SAMPLE_NAME.x==SAMPLE_NAME.y)) %>%
  filter(days.y>days.x) %>%
  mutate(days_delta = days.y-days.x) %>%
  filter(days_delta <= 60*60*24) -> host_sample_pairs_within_days






metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME,Enterotypes_id,branches,COLLECTION_TIMESTAMP) -> host_sample_enterotypes_branches
  
  
host_sample_pairs_within_days %>%
  merge(host_sample_enterotypes_branches, by.x=c("HOST_SUBJECT_ID","SAMPLE_NAME.x", "COLLECTION_TIMESTAMP.x"), by.y=c("HOST_SUBJECT_ID","SAMPLE_NAME","COLLECTION_TIMESTAMP")) %>%
  merge(host_sample_enterotypes_branches, by.x=c("HOST_SUBJECT_ID","SAMPLE_NAME.y", "COLLECTION_TIMESTAMP.y"), by.y=c("HOST_SUBJECT_ID","SAMPLE_NAME","COLLECTION_TIMESTAMP")) %>%
  merge(TS_agp_genus_P_B, by.x="SAMPLE_NAME.x", by.y="row.names") %>%
  merge(TS_agp_genus_P_B, by.x="SAMPLE_NAME.y", by.y="row.names") %>%
  dplyr::rename(Bacteroides1 = "k__Bacteria;p__Bacteroidetes;c__Bacteroidia;o__Bacteroidales;f__Bacteroidaceae;g__Bacteroides.x",
                Prevotella1  = "k__Bacteria;p__Bacteroidetes;c__Bacteroidia;o__Bacteroidales;f__Prevotellaceae;g__Prevotella.x",
                Bacteroides2 = "k__Bacteria;p__Bacteroidetes;c__Bacteroidia;o__Bacteroidales;f__Bacteroidaceae;g__Bacteroides.y",
                Prevotella2  = "k__Bacteria;p__Bacteroidetes;c__Bacteroidia;o__Bacteroidales;f__Prevotellaceae;g__Prevotella.y") %>%
  mutate(PB_ratio_1 = log2((Prevotella1+1)/(Bacteroides1+1)), PB_ratio_2 = log2((Prevotella2+1)/(Bacteroides2+1))) %>%
  mutate(delta = PB_ratio_2-PB_ratio_1) -> host_sample_enterotypes_branches_P_B_ratio

host_sample_enterotypes_branches_P_B_ratio %>%
  filter(branches.x %in% c("Bacteroides DMM types","Prevotella DMM types"),
         branches.y %in% c("Bacteroides DMM types","Prevotella DMM types")) %>%
  ggplot() + geom_bar(aes(x=paste(branches.x), fill=branches.y)) + coord_flip()



host_sample_enterotypes_branches_P_B_ratio %>%
  filter(branches.x %in% c("Bacteroides DMM types","Prevotella DMM types"),
         branches.y %in% c("Bacteroides DMM types","Prevotella DMM types")) %>%
  ggplot() + geom_boxplot(aes(y=delta, branches.x, fill=branches.y))



host_sample_enterotypes_branches_P_B_ratio %>%
  filter(branches.x %in% c("Bacteroides DMM types","Prevotella DMM types"),
         branches.y %in% c("Bacteroides DMM types","Prevotella DMM types")) %>%
  ggplot() + 
  geom_point(aes(x=PB_ratio_1, y=PB_ratio_2, color=paste(branches.x,"->",branches.y), size=days_delta < 1*60*60)) +
  geom_abline(slope=1,intercept = 0) +
  geom_abline(slope=1,intercept = -2.5, linetype=2) +
  geom_abline(slope=1,intercept = 2.5, linetype=2) +
  xlab("P/B ratio 1st sample") + ylab("P/B ratio 2nd sample") +
  scale_size_discrete("less than\n60 minutes") +
  scale_colour_discrete("") +
  cowplot::theme_cowplot() -> figS9B
  
figS9B


  
  host_sample_enterotypes_branches_P_B_ratio %>%
  filter(branches.x %in% c("Bacteroides DMM types","Prevotella DMM types"),
         branches.y %in% c("Bacteroides DMM types","Prevotella DMM types")) %>%
  filter(branches.x %in% "Prevotella DMM types") %>%
    mutate(less_than_one_hour = days_delta < 1*60*60) %>%
    xtabs(~branches.y + less_than_one_hour, data=.) #%>% chisq.test()
    
 
  host_sample_enterotypes_branches_P_B_ratio %>%
  filter(branches.x %in% c("Bacteroides DMM types","Prevotella DMM types"),
         branches.y %in% c("Bacteroides DMM types","Prevotella DMM types")) %>%
  filter(branches.x %in% "Bacteroides DMM types") %>%
    mutate(less_than_one_hour = days_delta < 1*60*60) %>%
    xtabs(~branches.y + less_than_one_hour, data=.) #%>% chisq.test()
  
       

```

check stool collet daily time

```{r}


host_sample_enterotypes_branches_P_B_ratio %>%
  filter(branches.x %in% c("Bacteroides DMM types","Prevotella DMM types"),
         branches.y %in% c("Bacteroides DMM types","Prevotella DMM types")) %>%
  ggplot() + 
  geom_point(aes(x=PB_ratio_1, y=PB_ratio_2, color=paste(branches.x,"->",branches.y), size=days_delta < 1*60*60)) +
  geom_abline(slope=1,intercept = 0) +
  geom_abline(slope=1,intercept = -2.5, linetype=2) +
  geom_abline(slope=1,intercept = 2.5, linetype=2) +
  xlab("P/B ratio 1st sample") + ylab("P/B ratio 2nd sample") +
  scale_size_discrete("less than\n60 minutes") +
  scale_colour_discrete("")

host_sample_enterotypes_branches_P_B_ratio %>%
  filter(branches.x %in% c("Bacteroides DMM types","Prevotella DMM types"),
         branches.y %in% c("Bacteroides DMM types","Prevotella DMM types")) %>%
  mutate(hours.x=COLLECTION_TIMESTAMP.x %>% lubridate::hour(), hours.y=COLLECTION_TIMESTAMP.y %>% lubridate::hour()) %>%
  mutate(daytime = ifelse(hours.x < 12 & hours.y < 12, "both morning", ifelse(hours.x >= 12 & hours.y >= 12, "both afternoon", "no"))) %>%
  ggplot() + 
  geom_point(aes(x=PB_ratio_1, y=PB_ratio_2, color=daytime)) +
  geom_abline(slope=1,intercept = 0) +
  geom_abline(slope=1,intercept = -2.5, linetype=2) +
  geom_abline(slope=1,intercept = 2.5, linetype=2) +
  xlab("P/B ratio 1st sample") + ylab("P/B ratio 2nd sample") +
  scale_size_discrete("less than\n60 minutes") +
  scale_colour_discrete("")
 




host_sample_enterotypes_branches_P_B_ratio %>%
  filter(branches.x %in% c("Bacteroides DMM types","Prevotella DMM types"),
         branches.y %in% c("Bacteroides DMM types","Prevotella DMM types")) %>%
  mutate(hours.x=COLLECTION_TIMESTAMP.x %>% lubridate::hour(), hours.y=COLLECTION_TIMESTAMP.y %>% lubridate::hour()) %>%
  mutate(daytime = ifelse(hours.x < 12 & hours.y < 12, "both morning", ifelse(hours.x >= 12 & hours.y >= 12, "both afternoon", "no"))) %>%
  filter(branches.x=="Prevotella DMM types"|branches.y=="Prevotella DMM types") %>%
  ggplot() +
  geom_boxplot(aes(fill=paste(branches.x,"->",branches.y),y=(PB_ratio_1+PB_ratio_2)/2,x=daytime)) +
  coord_flip()


host_sample_enterotypes_branches_P_B_ratio %>%
  filter(branches.x %in% c("Bacteroides DMM types","Prevotella DMM types"),
         branches.y %in% c("Bacteroides DMM types","Prevotella DMM types")) %>%
  mutate(hours.x=COLLECTION_TIMESTAMP.x %>% lubridate::hour(), hours.y=COLLECTION_TIMESTAMP.y %>% lubridate::hour()) %>%
  mutate(daytime = ifelse(hours.x < 12 & hours.y < 12, "both morning", ifelse(hours.x >= 12 & hours.y >= 12, "both afternoon", "no"))) %>%
  filter(branches.x=="Prevotella DMM types"|branches.y=="Prevotella DMM types") %>%
  ggplot() +
  geom_bar(aes(x=paste(branches.x,"->",branches.y), fill=daytime), position="fill" ) + xlab("") + coord_flip() 

host_sample_enterotypes_branches_P_B_ratio %>%
  filter(branches.x %in% c("Bacteroides DMM types","Prevotella DMM types"),
         branches.y %in% c("Bacteroides DMM types","Prevotella DMM types")) %>%
  mutate(hours.x=COLLECTION_TIMESTAMP.x %>% lubridate::hour(), hours.y=COLLECTION_TIMESTAMP.y %>% lubridate::hour()) %>%
  mutate(daytime = ifelse(hours.x < 12 & hours.y < 12, "both", ifelse(hours.x >= 12 & hours.y >= 12, "both", "no"))) %>%
  filter(branches.x=="Prevotella DMM types"|branches.y=="Prevotella DMM types") %>%
  ggplot() +
  geom_bar(aes(x=paste(branches.x,"->",branches.y), fill=daytime), position="fill" ) + xlab("") + coord_flip()


host_sample_enterotypes_branches_P_B_ratio %>%
  filter(branches.x %in% c("Bacteroides DMM types","Prevotella DMM types"),
         branches.y %in% c("Bacteroides DMM types","Prevotella DMM types")) %>%
  mutate(hours.x=COLLECTION_TIMESTAMP.x %>% lubridate::hour(), hours.y=COLLECTION_TIMESTAMP.y %>% lubridate::hour()) %>%
  mutate(daytime = ifelse(hours.x < 12 & hours.y < 12, "both", ifelse(hours.x >= 12 & hours.y >= 12, "both", "no"))) %>%
  filter(branches.x=="Prevotella DMM types"|branches.y=="Prevotella DMM types") %>%
  xtabs(~ paste(branches.x,"->",branches.y) + daytime, data=.) %>%
  chisq.test()


```


## figure supp 9

```{r fig.height=5, fig.width=16}

figS9A + figS9B + plot_annotation(tag_levels = "A")

ggsave("figures/figS9.pdf")

```



```{r}

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_date()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>% 
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(SAMPLE_NAME, HOST_SUBJECT_ID, days, sample_order, branches) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(same_branches_lag = ifelse(branches == lag(branches), "yes","no"), branches_before=lag(branches), days_delta= days - lag(days)) %>% 
  filter(sample_order >1) %>%
  mutate(branches_pairs=paste0(branches_before,"-",branches)) %>%
  mutate(days_delta_bins = cut(days_delta, breaks = c(0,7,30,120,365,10000))) %>%
  ungroup() %>%
  filter(is.na(days_delta_bins))



```


```{r}

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>% 
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(SAMPLE_NAME, HOST_SUBJECT_ID, days, sample_order, branches, COLLECTION_TIMESTAMP)


```
### stability by partition
```{r fig.height=4, fig.width=10}


metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>% 
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(SAMPLE_NAME, HOST_SUBJECT_ID, Enterotypes_id, days, sample_order, branches, COLLECTION_TIMESTAMP) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(delta_days = days-lag(days), enterotypes_before = lag(Enterotypes_id)) %>%
  mutate(stable=ifelse(enterotypes_before==Enterotypes_id,"stable","switch")) %>%
  na.omit() %>%
  filter(delta_days>24*60*60) %>%
  ggplot() + 
  geom_boxplot(aes(y=(delta_days)/(24*60*60), x=paste0("M",enterotypes_before), fill=stable)) + 
  scale_y_log10("days") + xlab("") + cowplot::theme_cowplot() -> p_partition_stability

p_partition_stability

p_partition_stability$data %>%
  filter(stable=="stable") %>%
  #group_by(enterotypes_before) %>%
  with(.,pairwise.wilcox.test(delta_days,enterotypes_before, data=.)) %>% broom::tidy()

p_partition_stability$data %>%
  #filter(stable=="stable") %>%
  #group_by(enterotypes_before) %>%
  with(.,pairwise.wilcox.test(delta_days,stable, data=.)) %>% broom::tidy()

p_partition_stability$data %>%
  group_by(stable) %>%
  summarise(m=median(delta_days/(24*60*60)), 
            q25=quantile(delta_days/(24*60*60), 0.25),
            q75=quantile(delta_days/(24*60*60), 0.75))


p_partition_stability$data %>%
  ggplot() + 
  geom_boxplot(aes(y=(delta_days)/(24*60*60), fill=stable)) +
  scale_y_log10("days") + xlab("") + cowplot::theme_cowplot()

```



```{r fig.height=8, fig.width=10}

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>%
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(HOST_SUBJECT_ID, days, sample_order, branches, Enterotypes_id, shannon) %>%
  mutate(Enterotypes_id = Enterotypes_id %>% as.character ) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  mutate(same_branches_lag = ifelse(branches == lag(branches), "yes","no"), 
         branches_before=lag(branches), days_delta= days - lag(days), 
         Enterotypes_id_before = lag(Enterotypes_id %>% as.character),
         shannon_before = lag(shannon)) %>%
  filter(sample_order >1) %>%
  mutate(branches_pairs=paste0(branches_before,"-",branches)) %>%
  mutate(days_delta_bins = cut(days_delta, breaks = c(-1,60*60*24,120*24*60*60,365*60*60*24,10000*60*60*24))) %>%
  filter(branches_before == "Bacteroides DMM types", branches == "Bacteroides DMM types") %>%
  
  select(shannon_before,shannon,Enterotypes_id,Enterotypes_id_before) %>%
    ungroup() %>%
  group_by(Enterotypes_id,Enterotypes_id_before) %>%
  summarise(shannon=median(shannon), shannon_before=median(shannon_before), n_p=n()) %>%
  ungroup() %>%
  group_by(Enterotypes_id_before) %>%
  mutate(prop_n_p = n_p/sum(n_p)) %>%
  group_by(Enterotypes_id_before) %>%
  arrange(Enterotypes_id_before, desc(prop_n_p)) %>%
  mutate(Enterotypes_id = Enterotypes_id %>% factor(level=c("2","4","3","10","8","6","15","11")),
         Enterotypes_id_before = Enterotypes_id_before %>% factor(level=c("2","4","3","10","8","6","15","11"))) %>% 
  mutate(shannon_sens = shannon_before> shannon, enterotype_sens = as.numeric(Enterotypes_id_before) > as.numeric(Enterotypes_id)) -> Bacteroides_enterotypes_shannon_pairs 




metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>%
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(HOST_SUBJECT_ID, days, sample_order, branches, Enterotypes_id, shannon) %>%
  mutate(Enterotypes_id = Enterotypes_id %>% as.character ) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  mutate(same_branches_lag = ifelse(branches == lag(branches), "yes","no"), 
         branches_before=lag(branches), days_delta= days - lag(days), 
         Enterotypes_id_before = lag(Enterotypes_id %>% as.character),
         shannon_before = lag(shannon)) %>%
  filter(sample_order >1) %>%
  mutate(branches_pairs=paste0(branches_before,"-",branches)) %>%
  mutate(days_delta_bins = cut(days_delta, breaks = c(-1,60*60*24,120*24*60*60,365*60*60*24,10000*60*60*24))) %>%
  filter(branches_before == "Prevotella DMM types", branches == "Prevotella DMM types") %>%
  
  select(shannon_before,shannon,Enterotypes_id,Enterotypes_id_before) %>%
    ungroup() %>%
  group_by(Enterotypes_id,Enterotypes_id_before) %>%
  summarise(shannon=median(shannon), shannon_before=median(shannon_before), n_p=n()) %>%
  ungroup() %>%
  group_by(Enterotypes_id_before) %>%
  mutate(prop_n_p = n_p/sum(n_p)) %>%
  group_by(Enterotypes_id_before) %>%
  arrange(Enterotypes_id_before, desc(prop_n_p)) %>%
  mutate(Enterotypes_id = Enterotypes_id %>% factor(level=c("7","17","16","14","18")),
         Enterotypes_id_before = Enterotypes_id_before %>% factor(level=c("7","17","16","14","18"))) %>% 
  mutate(shannon_sens = shannon_before> shannon, enterotype_sens = as.numeric(Enterotypes_id_before) > as.numeric(Enterotypes_id)) -> Prevotella_enterotypes_shannon_pairs 



cowplot::plot_grid(
Bacteroides_enterotypes_shannon_pairs %>%
  ungroup() %>%
  filter(!(Enterotypes_id==Enterotypes_id_before)) %>%
  group_by(Enterotypes_id_before) %>%
  arrange(Enterotypes_id_before, desc(n_p)) %>%
  dplyr::slice(1:2) %>%
  ggplot() + 
  geom_segment(aes(y=shannon_before, 
        yend=shannon, 
        x=Enterotypes_id_before %>% factor(level=c("2","4","3","10","8","6","15","11")), 
        xend=Enterotypes_id %>% factor(level=c("2","4","3","10","8","6","15","11")), 
        color=enterotype_sens), 
    arrow = arrow(length = unit(0.1,"cm"))) +
  ggrepel::geom_text_repel(aes(x=Enterotypes_id_before %>% factor(level=c("2","4","3","10","8","6","15","11")),
                y=shannon_before,
                label=round(prop_n_p,2) %>% scales::percent(accuracy=1))) +
  xlab("Bacteroides branch partition\nordered by PHATE centroid position") +
  ylab("alpha-diversity\n(Shannon)") +
  scale_color_discrete("", labels=c("toward branch-tip", "toward branch-root")),

Bacteroides_enterotypes_shannon_pairs %>%
  ungroup() %>%
  filter((Enterotypes_id==Enterotypes_id_before)) %>%
  ggplot() + 
  geom_bar(aes(x=Enterotypes_id_before,y=prop_n_p, fill=shannon), stat="identity") +
  scale_y_continuous(labels = scales::percent) +
  xlab("Bacteroides branch partition\nordered by PHATE centroid position") +
  ylab("stable participant sample-paired\nproportions"),





Prevotella_enterotypes_shannon_pairs %>%
  ungroup() %>%
  filter(!(Enterotypes_id==Enterotypes_id_before)) %>%
  group_by(Enterotypes_id_before) %>%
  arrange(Enterotypes_id_before, desc(n_p)) %>%
  dplyr::slice(1:2) %>%
  ggplot() + 
  geom_segment(aes(y=shannon_before, 
        yend=shannon, 
        x=Enterotypes_id_before %>% factor(level=c("7","17","16","14","18")), 
        xend=Enterotypes_id %>% factor(level=c("7","17","16","14","18")), 
        color=enterotype_sens), 
    arrow = arrow(length = unit(0.1,"cm"))) +
  ggrepel::geom_text_repel(aes(x=Enterotypes_id_before %>% factor(level=c("7","17","16","14","18")),
                y=shannon_before,
                label=round(prop_n_p,2) %>% scales::percent(accuracy=1))) +
  xlab("Prevotella branch partition\nordered by PHATE centroid position") +
  ylab("alpha-diversity\n(Shannon)") +
  scale_color_discrete("", labels=c("toward branch-tip", "toward branch-root")),

Prevotella_enterotypes_shannon_pairs %>%
  ungroup() %>%
  filter((Enterotypes_id==Enterotypes_id_before)) %>%
  ggplot() + 
  geom_bar(aes(x=Enterotypes_id_before,y=prop_n_p, fill=shannon), stat="identity") +
  scale_y_continuous(labels = scales::percent) +
  xlab("Prevotella branch partition\nordered by PHATE centroid position") +
  ylab("stable participant sample-paired\nproportions"), nrow = 2, rel_widths = c(2,1))





```

## gut microbiota partitions networks based on times series 

```{r}
```


```{r}
metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  
  
  filter(days == 0 | days > 60*60*24) %>%
  
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>%
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(HOST_SUBJECT_ID, days, sample_order, branches, Enterotypes_id, shannon) %>%
  mutate(Enterotypes_id = Enterotypes_id %>% as.character ) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  mutate(same_branches_lag = ifelse(branches == lag(branches), "yes","no"), 
         branches_before=lag(branches), days_delta= days - lag(days), 
         Enterotypes_id_before = lag(Enterotypes_id %>% as.character),
         shannon_before = lag(shannon)) %>%
  filter(sample_order >1) %>%
  mutate(branches_pairs=paste0(branches_before,"-",branches)) %>%
  mutate(days_delta_bins = cut(days_delta, breaks = c(-1,60*60*24*7,120*24*60*60,365*60*60*24,10000*60*60*24))) %>%
  ungroup() -> enterotypes_time_series_network_raw
  #filter(days_delta_bins %in% c("(-1,8.64e+04]","(8.64e+04,1.04e+07]")) %>%
  
enterotypes_time_series_network_raw %>%
group_by(Enterotypes_id_before,Enterotypes_id) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  arrange(Enterotypes_id_before,desc(n)) %>%
  group_by(Enterotypes_id_before) %>%
  mutate(p=n/sum(n))-> enterotypes_time_series_network
  #dplyr::slice(1:3)
```

### figure stability vs random
```{r fig.height=8, fig.width=8}
enterotypes_time_series_network %>%
  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  mutate(branches_before = case_when(Enterotypes_id_before %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id_before %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id_before %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id_before %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  mutate(group = ifelse(Enterotypes_id_before == Enterotypes_id, "within Partition", ifelse(branches_before==branches, "within Branches", "between Branches") )) %>%
  ggplot() + geom_bar(aes(x=Enterotypes_id_before, y=p, fill=group), stat="identity", position="fill") + 
  facet_wrap(~branches_before, scales = "free", nrow=1) 


enterotypes_time_series_network_raw %>%
  select(Enterotypes_id,Enterotypes_id_before) %>%
  mutate(Enterotypes_id = sample(Enterotypes_id)) %>%
  group_by(Enterotypes_id_before,Enterotypes_id) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  arrange(Enterotypes_id_before,desc(n)) %>%
  group_by(Enterotypes_id_before) %>%
  mutate(p=n/sum(n))   -> tmp


tmp %>%
  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  mutate(branches_before = case_when(Enterotypes_id_before %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id_before %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id_before %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id_before %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
#  mutate(group = ifelse(Enterotypes_id_before == Enterotypes_id, "within Partition", ifelse(branches_before==branches, "within Branches", "between Branches") )) %>%
 mutate(group = ifelse(branches_before==branches,"within Branches" ,"between Branches")) %>%
   ggplot() + geom_bar(aes(x=Enterotypes_id_before, y=p, fill=group), stat="identity") + 
  facet_wrap(~branches_before, scales = "free", nrow=1) 








enterotypes_time_series_network_random=NULL

for (i in 1:100) {
enterotypes_time_series_network_raw %>%
  select(Enterotypes_id,Enterotypes_id_before) %>%
  mutate(Enterotypes_id = sample(Enterotypes_id)) %>%
  group_by(Enterotypes_id_before,Enterotypes_id) %>%
  summarise(n=n()) %>%
  ungroup() %>%
  arrange(Enterotypes_id_before,desc(n)) %>%
  group_by(Enterotypes_id_before) %>%
  mutate(p=n/sum(n), iteration=i)   -> tmp

  enterotypes_time_series_network_random =
    rbind(enterotypes_time_series_network_random,tmp)
  

}


enterotypes_time_series_network_random %>%
  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  mutate(branches_before = case_when(Enterotypes_id_before %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id_before %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id_before %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id_before %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
 mutate(group = ifelse(Enterotypes_id_before == Enterotypes_id, "within Partition", ifelse(branches_before==branches, "within Branches", "between Branches") )) %>%
 #mutate(group = ifelse(branches_before==branches,"within Branches" ,"between Branches")) %>%
  group_by(Enterotypes_id_before,group,iteration) %>%
  summarise(p=sum(p)) %>%
  ggplot() + geom_boxplot(aes(x=Enterotypes_id_before, y=p, fill=group))



enterotypes_time_series_network_random %>%
  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella\nDMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides\nDMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales\nDMM types",
                              Enterotypes_id %in% c(13) ~ "Akk.",
                              TRUE ~ "outliers")
         ) %>%
  mutate(branches_before = case_when(Enterotypes_id_before %in% c(18,14,16,17,7) ~ "Prevotella\nDMM types",
                              Enterotypes_id_before %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides\nDMM types",
                              Enterotypes_id_before %in% c(12,1,5,9) ~ "Clostridiales\nDMM types",
                              Enterotypes_id_before %in% c(13) ~ "Akk.",
                              TRUE ~ "outliers")
         ) %>%
 mutate(group = ifelse(Enterotypes_id_before == Enterotypes_id, "within Partition", ifelse(branches_before==branches, "within Branch\nbetween Partitions", "between Branches") )) %>%
 #mutate(group = ifelse(branches_before==branches,"within Branches" ,"between Branches")) %>%
  group_by(Enterotypes_id_before,group,branches_before,iteration) %>%
  summarise(p=sum(p)) %>%
  ungroup() %>%
  select(-iteration) %>%
  group_by(Enterotypes_id_before,branches_before,group) %>%
  summarise(p95=quantile(p,0.95),p05=quantile(p,0.05)) %>%
  mutate(p=ifelse(group!="within Partition", p05,p95)) %>%
  select(-p95, -p05) %>%
  mutate(dataset="Randomized CI 95%") %>%
  
  rbind( 
          enterotypes_time_series_network %>%
  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella\nDMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides\nDMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales\nDMM types",
                              Enterotypes_id %in% c(13) ~ "Akk.",
                              TRUE ~ "outliers")
         ) %>%
  mutate(branches_before = case_when(Enterotypes_id_before %in% c(18,14,16,17,7) ~ "Prevotella\nDMM types",
                              Enterotypes_id_before %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides\nDMM types",
                              Enterotypes_id_before %in% c(12,1,5,9) ~ "Clostridiales\nDMM types",
                              Enterotypes_id_before %in% c(13) ~ "Akk.",
                              TRUE ~ "outliers")
         ) %>%
  mutate(group = ifelse(Enterotypes_id_before == Enterotypes_id, "within Partition", ifelse(branches_before==branches, "within Branch\nbetween Partitions", "between Branches") )) %>%
    
    group_by(Enterotypes_id_before,branches_before,group) %>%
  summarise(p=sum(p)) %>%
    mutate(dataset="Observed")
    ) %>%
  filter(group != "within Branch\nbetween Partitions") %>%
  mutate(group = group %>% forcats::fct_relevel("within Partition","between Branches")) %>%
ggplot() + geom_bar(aes(x=paste0("M",Enterotypes_id_before),y=p,fill=dataset),stat="identity", position = "dodge") +
  facet_grid(group~branches_before, scales = "free", space = "free") +
  cowplot::theme_cowplot() +
  xlab("Gut microbiome partitions") +
  ylab("Proportions") +
  theme(axis.text.x=element_text(angle=90,hjust=1, vjust=0.5)) + 
  theme(legend.position="bottom") -> fig5M_stability
  
  
fig5M_stability


```




```{r}
enterotypes_time_series_network


enterotypes_time_series_network %>%
  dplyr::slice(1) %>%
  pull(n) %>% sum

enterotypes_time_series_network %>%
  dplyr::slice(2:20) %>%
  pull(n) %>% sum

enterotypes_time_series_network %>%
  pull(n) %>% sum


  enterotypes_time_series_network %>%
    #ungroup() %>%
    filter(p>0.05) -> enterotypes_time_series_network

  

  
   
enterotypes_time_series_network %>%
  dplyr::slice(1) %>%
  pull(n) %>% sum

enterotypes_time_series_network %>%
  dplyr::slice(2:20) %>%
  pull(n) %>% sum

enterotypes_time_series_network %>%
  pull(n) %>% sum

enterotypes_time_series_network %>% write.table(file="enterotypes_time_series_network.txt", sep = "\t")  
  
enterotypes_time_series_network %>%
  group_by(Enterotypes_id_before) %>%
  summarise(p=sum(p)) %>% pull(p) %>% summary() # if you select the top 2 switches + stability (=>66% average)



enterotypes_time_series_network %>%
  filter(Enterotypes_id_before==Enterotypes_id) %>%
  select(Enterotypes_id_before,p) %>%
  dplyr::rename(stability=p, Enterotypes_id=Enterotypes_id_before)-> enterotypes_time_series_stability

enterotypes_time_series_network %>%
  filter(!(Enterotypes_id_before==Enterotypes_id)) %>%
  select(Enterotypes_id_before,Enterotypes_id, p) -> enterotypes_time_series_switch

# enterotypes_time_series_network %>%
#   filter(!(Enterotypes_id_before==Enterotypes_id)) %>%
#   select(Enterotypes_id_before,Enterotypes_id, n, p) %>%
#   filter(n>5) %>% select(Enterotypes_id_before,Enterotypes_id, p) -> enterotypes_time_series_switch

enterotypes_time_series_stability %>%
  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")) -> enterotypes_time_series_stability
```


```{r}
```


```{r fig.height=4, fig.width=6}
library(igraph)
library(ggraph)


#igraph::graph.data.frame(enterotypes_time_series_switch)
graph <- igraph::graph_from_data_frame(enterotypes_time_series_switch)

V(graph)

enterotypes_time_series_stability =
enterotypes_time_series_stability %>% .[match(names(V(graph)), enterotypes_time_series_stability$Enterotypes_id),]

V(graph)$stability <- enterotypes_time_series_stability$stability         
V(graph)$branches <-  enterotypes_time_series_stability$branches 
V(graph)$partition_names <-   enterotypes_time_series_stability$Enterotypes_id
  
ggraph(graph, weights=p, layout="stress") +
  geom_edge_fan(aes(alpha = p, color=p), arrow=arrow(angle = 20, length = unit(4, "mm")), end_cap = circle(3, 'mm')) + 
  #scale_alpha_ordinal("participants proportion") +
  #geom_node_point(aes(color=branches,size=stability*2)) +
  #geom_node_point(aes(color=branches,size=stability)) +
  geom_node_label(aes(label=partition_names, fill=branches %>% gsub("DMM types","",.), size=stability), shape=15) + 
  #geom_node_text(aes(label=partition_names), repel=TRUE) +
  scale_color_brewer(type="qual") +
  scale_fill_brewer("DMM types", type="qual") +
  scale_alpha_continuous("participants proportion") + 
  scale_edge_alpha("ind. proportion (switch)") + 
  scale_edge_color_continuous("ind. proportion (switch)", low = "grey", high ="red", guide = FALSE) +
  scale_size_continuous("ind. proportion (stable)", trans="log10", limits = c(0.1,0.9), breaks = c(0.3,0.6,0.9)) +
  theme_void() -> fig5A
  
fig5A

enterotypes_time_series_stability %>%
  #filter(branches=="Bacteroides DMM types"| Enterotypes_id %in% c(1,5)) %>%
  #mutate(Enterotypes_id=Enterotypes_id %>% as.character %>% factor(levels=c("1","5","2","4","3","8","10","6","15","11"))) %>%
  ggplot() + geom_bar(aes(x=Enterotypes_id, y=stability), stat="identity") +
  xlab("Bacteroides branch partitions\nordered by PHATE centroid position") +
  ylab("stability") +
  cowplot::theme_cowplot()
  

```

```{r}

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  
  
  filter(days == 0 | days > 60*60*24) %>%
  
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>%
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(SAMPLE_NAME,HOST_SUBJECT_ID, days, sample_order, branches, Enterotypes_id, shannon) %>%
  mutate(Enterotypes_id = Enterotypes_id %>% as.character ) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  mutate(same_branches_lag = ifelse(branches == lag(branches), "yes","no"), 
         branches_before=lag(branches), days_delta= days - lag(days), 
         Enterotypes_id_before = lag(Enterotypes_id %>% as.character),
         shannon_before = lag(shannon)) %>%
  filter(sample_order >1) %>%
  mutate(branches_pairs=paste0(branches_before,"-",branches)) %>%
  mutate(days_delta_bins = cut(days_delta, breaks = c(-1,60*60*24*7,120*24*60*60,365*60*60*24,10000*60*60*24))) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  select(SAMPLE_NAME,Enterotypes_id.x,Enterotypes_id_before,value) %>%
  mutate(stability=ifelse(Enterotypes_id.x==Enterotypes_id_before, "stable","unstable")) %>%
  #with(.,wilcox.test(data=., value~stability))
  #ggplot() + ggforce::geom_sina(aes(x=stability,y=value)) #+ facet_wrap(~Enterotypes_id_before)
  ggplot() + geom_bar(aes(x=stability,fill=value>0.8), position="fill") #+ facet_wrap(~Enterotypes_id.x)
  #ggplot() + geom_density(aes(x=value, fill=stability), alpha=0.5)


```




## main switches and keystone species

main switches occurred between #6 and #2, #3 and #5

### M6 M2
```{r}
#compute fprau/bacteroides ratio and merge

f_GG = "k__Bacteria;p__Firmicutes;c__Clostridia;o__Clostridiales;f__Ruminococcaceae;g__Faecalibacterium"
b_GG = "k__Bacteria;p__Bacteroidetes;c__Bacteroidia;o__Bacteroidales;f__Bacteroidaceae;g__Bacteroides"

genus %>%
  filter(taxa %in% c(f_GG,b_GG)) %>%
  tibble::column_to_rownames("taxa") %>%
  t %>%
  as.data.frame() %>%
  dplyr::rename(Feacalibacterium=2,Bacteroides=1) %>%
  mutate(ratio=Feacalibacterium/Bacteroides) -> f_b_ratio

# metadata %>%
#   filter(SAMPLE_TYPE == "Stool") %>%
#   select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
#   mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
#   merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
#   merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
#   filter(set != "outliers") %>%
#   filter(Enterotypes_id != 19) %>%
#   group_by(HOST_SUBJECT_ID) %>%
#   mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
#   filter(n>1) %>%
#   
#   mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
#   group_by(HOST_SUBJECT_ID) %>%
#   arrange(HOST_SUBJECT_ID, days) %>%
#   mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>%
#   filter(Enterotypes_id %in% c(2,6)) %>%
#   ggplot() + geom_line(aes(x=days,y=shannon,group=HOST_SUBJECT_ID, col=as.character(Enterotypes_id))) 
  

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
  merge(f_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  
  
  filter(days == 0 | days > 60*60*24) %>%
  
  
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>%
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(SAMPLE_NAME, HOST_SUBJECT_ID, days, sample_order, branches, Enterotypes_id, shannon, ratio) %>%
  mutate(Enterotypes_id = Enterotypes_id %>% as.character ) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  mutate(same_branches_lag = ifelse(branches == lag(branches), "yes","no"), 
         branches_before=lag(branches), days_delta= days - lag(days), 
         Enterotypes_id_before = lag(Enterotypes_id %>% as.character),
         shannon_before = lag(shannon),
         ratio_before = lag(ratio)) %>%
  filter(sample_order >1) %>%
  mutate(branches_pairs=paste0(branches_before,"-",branches)) %>%
  filter(Enterotypes_id %in% c(2,6), Enterotypes_id_before %in% c(2,6)) %>%
  ungroup() %>%
  select(SAMPLE_NAME,Enterotypes_id,shannon,ratio, Enterotypes_id_before,shannon_before, ratio_before) %>%
  mutate(switch=paste(Enterotypes_id,Enterotypes_id_before)) -> df

df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  ggplot() + geom_boxplot(aes(x=switch,y=delta_ratio)) + 
  ylab("Faecalibacterium/Bacteroides\nratio variation") + 
  xlab("") + cowplot::theme_cowplot() + 
  scale_x_discrete(label=c("within\npartition M2","between\nfrom M2 to M6","between\nfrom M6 to M2","within\npartition M6")) -> fig5B

fig5B

df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  with(.,pairwise.wilcox.test(delta_ratio,switch, data=.))


rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(ratio)) %>%
  mutate(stable = ifelse(switch %in% c("2 2","6 6"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("2 2","2 6"), "M2","M6")  ) %>%
  #arrange(switch) %>%
  ggplot() + geom_line(aes(x=ratio,y=SAMPLE_NAME, group=SAMPLE_NAME, col=stable))  + theme(axis.text.y = element_blank()) + scale_x_continuous(trans = "log2") + 
  #facet_wrap(~switch, ncol=1, scale="free_y") +
  cowplot::theme_cowplot() +
  ylab("AGP participants") + xlab("Faecalibacterium/\nBacteroides ratio") +
  scale_color_manual("", values=c("black","red"), label=c("stable","unstable")) +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) + 
  facet_grid(start_partition~., scales = "free_y")


rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(shannon)) %>%
  mutate(stable = ifelse(switch %in% c("2 2","6 6"), "stable","unstable")  ) %>%
  #filter(stable == "stable") %>%
  ggplot() + 
  geom_point(aes(x=ratio,y=shannon,col=switch))+ 
  geom_line(aes(x=ratio,y=shannon,group=SAMPLE_NAME ,col=switch)) +
  scale_x_continuous(trans = "log2") + facet_wrap(~stable) -> fig5J_ellispse

fig5J_ellispse


df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  merge(f_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(Enterotypes_id%>%as.numeric)) %>%
  ggplot() + geom_density(aes(x=ratio, fill=switch), alpha=0.5)  + theme(axis.text.y = element_blank()) + scale_x_continuous(trans = "log2")

df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  merge(f_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(Enterotypes_id%>%as.numeric)) %>%
  ggplot() + 
  #geom_density(aes(x=ratio), alpha=0.5)  + 
  geom_density(aes(x=ratio, color=switch), alpha=0.5)  +
  cowplot::theme_cowplot() +
  theme(axis.text.y = element_blank()) + 
  scale_x_continuous(trans = "log2")

# df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
#   filter(switch %in% c("2 2", "2 6")) %>%
#   merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
#   reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
#   ggplot() + geom_boxplot(aes(x=switch, y=value)) + facet_wrap(~variable, scale="free")


df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("2 2", "2 6")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
  group_by(variable) %>%
  tidyr::nest()  %>% 
  mutate(wilcox_test=purrr::map(data,~wilcox.test(.x$value~.x$switch)),
        tidy=purrr::map(wilcox_test, broom::tidy)) %>% 
      tidyr::unnest(tidy,.drop=TRUE) %>%
  arrange(p.value) %>%
  ungroup() %>%
  #mutate(p.value=p.adjust(p.value, method="fdr")) %>%
  filter(p.value<0.05) %>% select(variable,p.value) %>% write.csv2(file="metadata_link_22vs26.csv")


df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("6 6", "6 2")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
  group_by(variable) %>%
  tidyr::nest()  %>% 
  mutate(wilcox_test=purrr::map(data,~wilcox.test(.x$value~.x$switch)),
        tidy=purrr::map(wilcox_test, broom::tidy)) %>% 
      tidyr::unnest(tidy,.drop=TRUE) %>%
  arrange(p.value) %>%
  ungroup() %>%
  #mutate(p.value=p.adjust(p.value, method="fdr"))%>%
  filter(p.value<0.05) %>% select(variable,p.value) %>% write.csv2(file="metadata_link_66vs62.csv")


df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  ggplot() + geom_point(aes(x=log2(ratio_before) - log2(ratio),y=log2(shannon_before/shannon), color=switch)) +
  xlim(-4,4) + ylim(-0.5, 0.5) + cowplot::theme_cowplot() + scale_color_brewer("", type="qual", palette = 2) +
  xlab("Feacalibacterium/Bacteroides variation") + ylab("alpha-diversity variation") -> figS10A




rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(ratio)) %>%
  mutate(stable = ifelse(switch %in% c("2 2","6 6"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("2 2","2 6"), "M2","M6")  ) %>%
  mutate(start_partition = start_partition %>% forcats::fct_reorder(ratio, .desc=TRUE)) %>%
  #arrange(switch) %>%
  ggplot() + geom_line(aes(x=ratio,y=SAMPLE_NAME, group=SAMPLE_NAME, col=stable))  + theme(axis.text.y = element_blank()) + scale_x_continuous(trans = "log2") + 
  #facet_wrap(~switch, ncol=1, scale="free_y") +
  cowplot::theme_cowplot() +
  ylab("AGP participants") + xlab("Faecalibacterium/\nBacteroides ratio") +
  scale_color_manual("", values=c("black","red"), label=c("stable","unstable")) +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) + 
  facet_grid(start_partition~., scales = "free_y") -> fig5B_full


df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  mutate(stable = ifelse(switch %in% c("2 2","6 6"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("2 2","2 6"), "M2","M6")  ) %>%
  mutate(start_partition = start_partition %>% forcats::fct_reorder(ratio, .desc=TRUE)) %>%
  ggplot() + geom_boxplot(aes(x=start_partition,y=delta_ratio, col=stable)) + 
  ylab("Faecalibacterium/Bacteroides\nratio variation") + 
  #scale_y_continuous(trans="log2") +
  xlab("") + cowplot::theme_cowplot() + scale_color_manual("",values=c("black","red")) -> fig5Binset


fig5B = fig5B_full + inset_element(fig5Binset+ylab("variation")+guides(color=FALSE), 0.65,-0.1,1,0.3, ignore_tag = TRUE)

fig5B

```

```{r}

rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(ratio)) %>%
  mutate(stable = ifelse(switch %in% c("2 2","6 6"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("2 2","2 6"), "M2","M6")  ) %>%
  mutate(start_partition = start_partition %>% forcats::fct_reorder(ratio, .desc=TRUE)) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  #with(.,wilcox.test(data=., value~stable))
  ggplot() + ggforce::geom_sina	(aes(x=stable,y=value,color=Enterotypes_id.x))


rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(ratio)) %>%
  mutate(stable = ifelse(switch %in% c("2 2","6 6"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("2 2","2 6"), "M2","M6")  ) %>%
  mutate(start_partition = start_partition %>% forcats::fct_reorder(ratio, .desc=TRUE)) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  group_by(switch) %>%
  summarise(q05 = quantile(ratio, 0.05), 
            q25 = quantile(ratio, 0.25), 
            q50=median(ratio), 
            q75 = quantile(ratio, 0.75),
            q95 = quantile(ratio, 0.95))


```


### pca analysis
```{r}

library(ade4)

cbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  #filter(switch %in% c("2 2", "2 6", "6 6", "6 2")) %>%
  filter(switch %in% c("2 2", "6 6")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  select(1:4),


df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  #filter(switch %in% c("2 2", "2 6", "6 6", "6 2")) %>%
  filter(switch %in% c("2 2", "6 6")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  select(-1,-2,-3,-4) %>%
  ade4::dudi.pca(scannf = FALSE, nf=2) %>%
  .$li) %>%
  ggplot() + geom_point(aes(x=Axis1, y=Axis2, col=switch))







df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("2 2", "2 6", "6 6", "6 2")) %>%
  filter(switch %in% c("2 2", "6 6")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  select(-1,-2,-3,-4) -> df_pca_prep
  
ade4::dudi.pca(df_pca_prep, scannf = FALSE, nf=2) -> pca_2_6


df %>% 
  select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>% 
  filter(switch %in% c("2 2", "2 6", "6 6", "6 2")) %>%
  filter(switch %in% c("2 2", "6 6")) %>%
  pull(switch) %>% as.factor() -> df_fac
  ade4::bca(pca_2_6, fac=df_fac, scannf=F) %>% randtest()




cbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("2 2", "2 6", "6 6", "6 2")) %>%
  #filter(switch %in% c("2 2", "6 6")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  select(1:4),


df %>% 
  select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>% 
  filter(switch %in% c("2 2", "2 6", "6 6", "6 2")) %>%
  pull(switch) %>% as.factor() %>%
  ade4::bca(pca_2_6, fac=., scannf=F) %>%
  .$ls) %>%
  ggplot() + geom_point(aes(x=CS1,y=CS2,color=switch))






```



```{r fig.height=10, fig.width=10}
rbind(
df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("2 2", "2 6")) %>%
  mutate(switch= switch %>% factor(levels = c("2 2", "2 6"))) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
  group_by(variable) %>%
  tidyr::nest()  %>% 
  mutate(cor_test=purrr::map(data,~cor.test(.x$value,.x$switch %>% as.factor %>% as.numeric(), method="spearman")),
        tidy=purrr::map(cor_test, broom::tidy)) %>% 
      tidyr::unnest(tidy,.drop=TRUE) %>%
  arrange(p.value) %>%
  mutate(switch=c("2->6")) %>%
  select(variable,estimate,p.value,switch) %>% mutate(q.value=p.adjust(p.value,"fdr")),


df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("6 6", "6 2")) %>% 
  mutate(switch= switch %>% factor(levels = c("6 6", "6 2"))) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
  group_by(variable) %>%
  tidyr::nest()  %>% 
  mutate(cor_test=purrr::map(data,~cor.test(.x$value,.x$switch %>% as.factor %>% as.numeric(), method="spearman")),
        tidy=purrr::map(cor_test, broom::tidy)) %>% 
      tidyr::unnest(tidy,.drop=TRUE) %>%
  arrange(p.value) %>%
  mutate(switch=c("6->2")) %>%
  select(variable,estimate,p.value,switch) %>% mutate(q.value=p.adjust(p.value,"fdr"))) %>%
  
  filter(q.value<0.05) %>%
  
ggplot() + geom_bar(aes(x=variable,y=estimate,fill=switch), position = "dodge", stat = "identity") + coord_flip() + cowplot::theme_cowplot() -> fig5D
  


df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  select(SAMPLE_NAME,Enterotypes_id, shannon, switch) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch","shannon","shannon_before","ratio","ratio_before")) 



```




```{r}
library(caret)
set.seed(666)
train.control <- trainControl(method = "repeatedcv", 
                              summaryFunction=twoClassSummary,
                              number = 10, repeats = 5, classProbs=T, savePredictions = T)

df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("2 2", "2 6")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>% select(-SAMPLE_NAME,-Enterotypes_id) %>% mutate(switch = paste0("p",switch) %>% gsub("\\ ","",.) %>% as.factor)   -> df_22_26
  

# Train the model
suppressWarnings(model <- train(switch ~., data = df_22_26, method = "rf",
               trControl = train.control))
# Summarize the results
print(model)


library(pROC)
# Select a parameter setting
selectedIndices <- model$pred$mtry == 2
#selectedIndices <- model$pred$ncomp == 1
# Plot:
plot.roc(model$pred$obs[selectedIndices],
         model$pred$p26[selectedIndices])
```





### M5 M3

```{r}
metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
  merge(f_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  
  filter(days == 0 | days > 60*60*24) %>%
  
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>%
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(SAMPLE_NAME, HOST_SUBJECT_ID, days, sample_order, branches, Enterotypes_id, shannon, ratio) %>%
  mutate(Enterotypes_id = Enterotypes_id %>% as.character ) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  mutate(same_branches_lag = ifelse(branches == lag(branches), "yes","no"), 
         branches_before=lag(branches), days_delta= days - lag(days), 
         Enterotypes_id_before = lag(Enterotypes_id %>% as.character),
         shannon_before = lag(shannon),
         ratio_before = lag(ratio)) %>%
  filter(sample_order >1) %>%
  mutate(branches_pairs=paste0(branches_before,"-",branches)) %>%
  filter(Enterotypes_id %in% c(3,5), Enterotypes_id_before %in% c(3,5)) %>%
  ungroup() %>%
  select(SAMPLE_NAME,Enterotypes_id,shannon,ratio, Enterotypes_id_before,shannon_before, ratio_before) %>%
  mutate(switch=paste(Enterotypes_id,Enterotypes_id_before)) -> df

df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  ggplot() + geom_boxplot(aes(x=switch,y=delta_ratio)) + 
  ylab("Faecalibacterium/Bacteroides\nratio variation") + 
  xlab("") + cowplot::theme_cowplot() + 
  scale_x_discrete(label=c("within\npartition M3","between\nfrom M3 to M5","between\nfrom M5 to M3","within\npartition M5")) -> fig5C

fig5C



df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  with(.,pairwise.wilcox.test(delta_ratio,switch, data=.))


rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(ratio)) %>%
  arrange(switch) %>%
  ggplot() + geom_line(aes(x=ratio,y=SAMPLE_NAME, group=SAMPLE_NAME, col=switch))  + theme(axis.text.y = element_blank()) + scale_x_continuous(trans = "log2") + facet_wrap(~switch, ncol=1, scale="free_y") 

df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  merge(f_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(Enterotypes_id%>%as.numeric)) %>%
  ggplot() + geom_density(aes(x=ratio, fill=switch), alpha=0.5)  + theme(axis.text.y = element_blank()) + scale_x_continuous(trans = "log2")



rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(shannon)) %>%
  mutate(stable = ifelse(switch %in% c("3 3","5 5"), "stable","unstable")  ) %>%
  #filter(stable == "stable") %>%
  ggplot() + 
  geom_point(aes(x=ratio,y=shannon,col=switch))+ 
  geom_line(aes(x=ratio,y=shannon,group=SAMPLE_NAME ,col=switch)) +
  scale_x_continuous(trans = "log2") + facet_wrap(~stable) -> fig5K_ellispse

fig5K_ellispse



df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("5 5", "5 3")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
  ggplot() + geom_boxplot(aes(x=switch, y=value)) + facet_wrap(~variable, scale="free")

df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("5 5", "3 3")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
  ggplot() + geom_boxplot(aes(x=switch, y=value)) + facet_wrap(~variable, scale="free")



df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("5 5", "5 3")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
  group_by(variable) %>%
  tidyr::nest()  %>% 
  mutate(wilcox_test=purrr::map(data,~wilcox.test(.x$value~.x$switch)),
        tidy=purrr::map(wilcox_test, broom::tidy)) %>% 
      tidyr::unnest(tidy,.drop=TRUE) %>%
  arrange(p.value) %>%
  ungroup() %>%
#mutate(p.value=p.adjust(p.value, method="fdr")) %>%
  filter(p.value<0.05) %>% select(variable,p.value) %>% write.csv2(file="metadata_link_55vs53.csv")




df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("3 3", "3 5")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
  group_by(variable) %>%
  tidyr::nest()  %>% 
  mutate(wilcox_test=purrr::map(data,~wilcox.test(.x$value~.x$switch)),
        tidy=purrr::map(wilcox_test, broom::tidy)) %>% 
      tidyr::unnest(tidy,.drop=TRUE) %>%
  arrange(p.value) %>%
  ungroup() %>%
  #mutate(p.value=p.adjust(p.value, method="fdr")) %>%
  filter(p.value<0.05) %>% select(variable,p.value) %>% write.csv2(file="metadata_link_33vs35.csv")






df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("3 3", "5 5")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
  group_by(variable) %>%
  tidyr::nest()  %>% 
  mutate(wilcox_test=purrr::map(data,~wilcox.test(.x$value~.x$switch)),
        tidy=purrr::map(wilcox_test, broom::tidy)) %>% 
      tidyr::unnest(tidy,.drop=TRUE) %>%
  arrange(p.value) %>%
  ungroup() %>%
#mutate(p.value=p.adjust(p.value, method="fdr")) %>%
  filter(p.value<0.05) %>% select(variable,p.value) %>% write.csv2(file="metadata_link_33vs55.csv")




df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  ggplot() + geom_point(aes(x=log2(ratio_before) - log2(ratio),y=log2(shannon_before/shannon), color=switch)) +
  xlim(-4,4) + ylim(-0.5, 0.5) + cowplot::theme_cowplot() + scale_color_brewer("", type="qual", palette = 2) +
  xlab("Feacalibacterium/Bacteroides variation") + ylab("alpha-diversity variation") -> figS10B





rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(ratio)) %>%
  mutate(stable = ifelse(switch %in% c("5 5","3 3"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("5 5","5 3"), "M5","M3")  ) %>%
  mutate(start_partition = start_partition %>% forcats::fct_reorder(ratio, .desc=TRUE)) %>%
  #arrange(switch) %>%
  ggplot() + geom_line(aes(x=ratio,y=SAMPLE_NAME, group=SAMPLE_NAME, col=stable))  + theme(axis.text.y = element_blank()) + scale_x_continuous(trans = "log2") + 
  #facet_wrap(~switch, ncol=1, scale="free_y") +
  cowplot::theme_cowplot() +
  ylab("AGP participants") + xlab("Faecalibacterium/\nBacteroides ratio") +
  scale_color_manual("", values=c("black","red"), label=c("stable","unstable")) +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) + 
  facet_grid(start_partition~., scales = "free_y") -> fig5C_full


df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  mutate(stable = ifelse(switch %in% c("5 5","3 3"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("5 5","5 3"), "M5","M3")  ) %>%
  mutate(start_partition = start_partition %>% forcats::fct_reorder(ratio, .desc=TRUE)) %>%
  ggplot() + geom_boxplot(aes(x=start_partition,y=delta_ratio, col=stable)) + 
  ylab("Faecalibacterium/Bacteroides\nratio variation") + 
  #scale_y_continuous(trans="log2") +
  xlab("") + cowplot::theme_cowplot() + scale_color_manual("",values=c("black","red")) -> fig5Cinset


fig5C = fig5C_full + inset_element(fig5Cinset+ylab("variation")+guides(color=FALSE), 0.6,-0.1,1,0.3, ignore_tag = TRUE) + plot_annotation(tag_levels = "A")



df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  merge(f_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(Enterotypes_id%>%as.numeric)) %>%
  mutate(stable = ifelse(switch %in% c("5 5","3 3"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("5 5","5 3"), "M5","M3")  ) %>%
  #filter(stable!="stable") %>%
  ggplot() + geom_histogram(aes(x=ratio), alpha=0.5)  + theme(axis.text.y = element_blank()) + scale_x_continuous(trans = "log2")

df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  merge(f_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(Enterotypes_id%>%as.numeric)) %>%
  mutate(stable = ifelse(switch %in% c("5 5","3 3"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("5 5","5 3"), "M5","M3")  ) %>% 
  #filter(stable!="stable") %>%
  pull(ratio) %>%
  log(.,2) %>% diptest::dip.test()


```
```{r}


rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(ratio)) %>%
  mutate(stable = ifelse(switch %in% c("5 5","3 3"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("5 5","5 3"), "M5","M3")  ) %>%
  mutate(start_partition = start_partition %>% forcats::fct_reorder(ratio, .desc=TRUE)) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  #with(.,wilcox.test(data=., value~stable))
  #ggplot() + ggforce::geom_sina	(aes(x=stable,y=value,color=Enterotypes_id.x))
  ggplot() + geom_bar(aes(x=stable,fill=value>0.9), position="fill")

rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(ratio)) %>%
  mutate(stable = ifelse(switch %in% c("5 5","3 3"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("5 5","5 3"), "M5","M3")  ) %>%
  mutate(start_partition = start_partition %>% forcats::fct_reorder(ratio, .desc=TRUE)) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  filter(value>quantile(value,2/3)|value<quantile(value,1/3)) %>%
  mutate(value=value>quantile(value,0.5)) %>%
  with(., chisq.test(stable,value))
  
  
  #ggplot() + geom_bar(aes(x=stable,fill=value>quantile(value,0.5)), position="fill") + scale_fill_brewer("")


rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(ratio)) %>%
  mutate(stable = ifelse(switch %in% c("5 5","3 3"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("5 5","5 3"), "M5","M3")  ) %>%
  mutate(start_partition = start_partition %>% forcats::fct_reorder(ratio, .desc=TRUE)) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  filter(value>0.99, stable==stable) %>%
  pull(ratio) %>% diptest::dip.test()
  
  #ggplot() + geom_density(aes(x=ratio)) + scale_x_continuous(trans="log2")
  

rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(ratio)) %>%
  mutate(stable = ifelse(switch %in% c("2 2","6 6"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("2 2","2 6"), "M2","M6")  ) %>%
  mutate(start_partition = start_partition %>% forcats::fct_reorder(ratio, .desc=TRUE)) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  group_by(switch) %>%
  summarise(q05 = quantile(ratio, 0.05), q25 = quantile(ratio, 0.25), q50=median(ratio),  q75 = quantile(ratio, 0.75), q95 = quantile(ratio, 0.95))

```


### pca
```{r}


library(ade4)

cbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  #filter(switch %in% c("3 3", "3 5", "5 5", "5 3")) %>%
  filter(switch %in% c("3 3", "5 5")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  select(1:4),


df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  #filter(switch %in% c("3 3", "3 5", "5 5", "5 3")) %>%
  filter(switch %in% c("3 3", "5 5")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  select(-1,-2,-3,-4) %>%
  ade4::dudi.pca(scannf = FALSE, nf=2) %>%
  .$li) %>%
  ggplot() + geom_point(aes(x=Axis1, y=Axis2, col=switch))







df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("3 3", "3 5", "5 5", "5 3")) %>%
  #filter(switch %in% c("3 3", "5 5")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  select(-1,-2,-3,-4) -> df_pca_prep
  
ade4::dudi.pca(df_pca_prep, scannf = FALSE, nf=2) -> pca_3_5


df %>% 
  select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>% 
  filter(switch %in% c("3 3", "3 5", "5 5", "5 3")) %>%
  #filter(switch %in% c("3 3", "5 5")) %>%
  pull(switch) %>% as.factor() -> df_fac
  ade4::bca(pca_3_5, fac=df_fac, scannf=F) %>% randtest()


df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("3 3", "3 5", "5 5", "5 3")) %>%
  #filter(switch %in% c("3 3", "5 5")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  select(-1,-2,-3,-4) -> df_pca_prep
  
ade4::dudi.pca(df_pca_prep, scannf = FALSE, nf=2) -> pca_3_5




cbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("3 3", "3 5", "5 5", "5 3")) %>%
  #filter(switch %in% c("3 3", "5 5")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  select(1:4),


df %>% 
  select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>% 
  filter(switch %in% c("3 3", "3 5", "5 5", "5 3")) %>%
  #filter(switch %in% c("3 3", "5 5")) %>%
  pull(switch) %>% as.factor() %>%
  ade4::bca(pca_3_5, fac=., scannf=F) %>%
  .$ls) %>%
  ggplot() + geom_boxplot(aes(y=CS1, x=switch)) 





```





```{r fig.height=10, fig.width=10}
rbind(
df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("3 3", "3 5")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
  group_by(variable) %>%
  tidyr::nest()  %>% 
  mutate(cor_test=purrr::map(data,~cor.test(.x$value,.x$switch %>% as.factor %>% as.numeric(), method="spearman")),
        tidy=purrr::map(cor_test, broom::tidy)) %>% 
      tidyr::unnest(tidy,.drop=TRUE) %>%
  arrange(p.value) %>%
  mutate(switch=c("3->5")) %>%
  select(variable,estimate,p.value,switch),


df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("5 5", "5 3")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
  group_by(variable) %>%
  tidyr::nest()  %>% 
  mutate(cor_test=purrr::map(data,~cor.test(.x$value,.x$switch %>% as.factor %>% as.numeric(), method="spearman")),
        tidy=purrr::map(cor_test, broom::tidy)) %>% 
      tidyr::unnest(tidy,.drop=TRUE) %>%
  arrange(p.value) %>%
  mutate(switch=c("5->3")) %>%
  select(variable,estimate,p.value,switch)) %>%
  filter(p.value<0.05) %>%
  
ggplot() + geom_bar(aes(x=variable,y=estimate,fill=switch), position = "dodge", stat = "identity") + coord_flip() + cowplot::theme_cowplot() -> fig5E
  

```



```{r}
library(caret)
set.seed(666)
train.control <- trainControl(method = "repeatedcv", 
                              summaryFunction=twoClassSummary,
                              number = 10, repeats = 5, classProbs=T, savePredictions = T)

df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("5 5", "5 3")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>% select(-SAMPLE_NAME,-Enterotypes_id, -shannon) %>% mutate(switch = paste0("p",switch) %>% gsub("\\ ","",.) %>% as.factor)   -> df_55_53
  

# Train the model
suppressWarnings(model <- train(switch ~., data = df_55_53, method = "rf",
               trControl = train.control, preProc=c("center", "scale")))
# Summarize the results
print(model)

varImp(model, scale = FALSE, useModel=TRUE)
roc_imp <- filterVarImp(x = df_55_53 %>% select(-switch), y = df_55_53$switch)


library(pROC)
# Select a parameter setting
selectedIndices <- model$pred$mtry == 100
# Plot:
plot.roc(model$pred$obs[selectedIndices],
         model$pred$p55[selectedIndices])
```




## Figure 5 - Time series


```{r fig.height=6, fig.width=12}

library(patchwork)


#(fig5A | (fig5B/fig5C)|(fig5D/fig5E)) + plot_layout(widths = c(2,1,1.5)) +plot_annotation(tag_levels = "A")

# patch_plot = ((fig5A + plot_annotation(tag_levels = "A")) | 
#     
#     ((fig5B_full + plot_annotation(tag_levels = "B") +
#        inset_element(fig5Binset + 
#                        ylab("variation")+
#                        guides(color=FALSE), 0.6,-0.1,1,0.3, ignore_tag = FALSE))/
#        
#        (fig5C_full + plot_annotation(tag_levels = "C") +
#        inset_element(fig5Cinset+
#                        ylab("variation")+
#                        guides(color=FALSE), 0.6,-0.1,1,0.3, ignore_tag = FALSE)))) +
#   plot_annotation(tag_levels = "A")  + plot_layout(widths = c(2,1.5))
# 
# patch_plot[[2]][[1]] + plot_annotation(tag_levels = "A")


((fig5A) | (fig5B_full/fig5C_full)) + plot_annotation(tag_levels = "a") + plot_layout(widths = c(2,1.5))

ggsave("figures/figure5_bis.pdf")

```


```{r}

genus %>%
  filter(taxa %in% c(f_GG,b_GG)) %>%
  tibble::column_to_rownames("taxa") %>%
  t %>%
  as.data.frame() %>%
  dplyr::rename(Feacalibacterium=2,Bacteroides=1) %>%
  mutate(ratio=Feacalibacterium/Bacteroides) -> f_b_ratio

# metadata %>%
#   filter(SAMPLE_TYPE == "Stool") %>%
#   select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
#   mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
#   merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
#   merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
#   filter(set != "outliers") %>%
#   filter(Enterotypes_id != 19) %>%
#   group_by(HOST_SUBJECT_ID) %>%
#   mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
#   filter(n>1) %>%
#   
#   mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
#   group_by(HOST_SUBJECT_ID) %>%
#   arrange(HOST_SUBJECT_ID, days) %>%
#   mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>%
#   filter(Enterotypes_id %in% c(2,6)) %>%
#   ggplot() + geom_line(aes(x=days,y=shannon,group=HOST_SUBJECT_ID, col=as.character(Enterotypes_id))) 
  

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
  merge(f_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  #filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  
  
  filter(days == 0 | days > 60*60*24) %>%
  
  
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>%
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(SAMPLE_NAME, HOST_SUBJECT_ID, days, sample_order, branches, Enterotypes_id, shannon, ratio) %>%
  mutate(Enterotypes_id = Enterotypes_id %>% as.character ) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  mutate(same_branches_lag = ifelse(branches == lag(branches), "yes","no"), 
         branches_before=lag(branches), days_delta= days - lag(days), 
         Enterotypes_id_before = lag(Enterotypes_id %>% as.character),
         shannon_before = lag(shannon),
         ratio_before = lag(ratio)) %>%
  filter(sample_order >1) %>%
  mutate(branches_pairs=paste0(branches_before,"-",branches)) %>%
  #filter(Enterotypes_id %in% c(2,6), Enterotypes_id_before %in% c(2,6)) %>%
  ungroup() %>%
  select(SAMPLE_NAME,Enterotypes_id,shannon,ratio, Enterotypes_id_before,shannon_before, ratio_before) %>%
  mutate(switch=paste(Enterotypes_id,Enterotypes_id_before)) -> df



metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
  merge(f_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  filter(Enterotypes_id %in% c(11,15,6,8,10,3,4,2,5,1)) %>%
  ggplot() + geom_boxplot(aes(x=log2(ratio), y=as.character(Enterotypes_id)))



```
### fig supp
```{r fig.height=5, fig.width=10}

figS10A + figS10B + patchwork::plot_annotation(tag_level = "a")


ggsave("figS10.pdf")

```

## descriptive stat


```{r}
genus %>%
  filter(taxa %in% c(f_GG,b_GG)) %>%
  tibble::column_to_rownames("taxa") %>%
  t %>%
  as.data.frame() %>%
  dplyr::rename(Feacalibacterium=2,Bacteroides=1) %>%
  mutate(ratio=Feacalibacterium/Bacteroides) -> f_b_ratio

# metadata %>%
#   filter(SAMPLE_TYPE == "Stool") %>%
#   select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
#   mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
#   merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
#   merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
#   filter(set != "outliers") %>%
#   filter(Enterotypes_id != 19) %>%
#   group_by(HOST_SUBJECT_ID) %>%
#   mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
#   filter(n>1) %>%
#   
#   mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
#   group_by(HOST_SUBJECT_ID) %>%
#   arrange(HOST_SUBJECT_ID, days) %>%
#   mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>%
#   filter(Enterotypes_id %in% c(2,6)) %>%
#   ggplot() + geom_line(aes(x=days,y=shannon,group=HOST_SUBJECT_ID, col=as.character(Enterotypes_id))) 
  

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
  merge(f_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  #filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  
  
  filter(days == 0 | days > 60*60*24) %>%
  
  
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>%
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(SAMPLE_NAME, HOST_SUBJECT_ID, days, sample_order, branches, Enterotypes_id, shannon, ratio) %>%
  mutate(Enterotypes_id = Enterotypes_id %>% as.character ) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  mutate(same_branches_lag = ifelse(branches == lag(branches), "yes","no"), 
         branches_before=lag(branches), days_delta= days - lag(days), 
         Enterotypes_id_before = lag(Enterotypes_id %>% as.character),
         shannon_before = lag(shannon),
         ratio_before = lag(ratio)) %>%
  filter(sample_order >1) %>%
  mutate(branches_pairs=paste0(branches_before,"-",branches)) %>%
  #filter(Enterotypes_id %in% c(2,6), Enterotypes_id_before %in% c(2,6)) %>%
  ungroup() -> metadata_time_tmp

metadata_time_tmp$HOST_SUBJECT_ID %>% length()

metadata_time_tmp$HOST_SUBJECT_ID %>% unique %>% length()

median(metadata_time_tmp$days_delta) / (60*60*24)

quantile(metadata_time_tmp$days_delta, c(0.25,0.75)) / (60*60*24)



metadata_time_tmp %>%
  filter(Enterotypes_id_before == Enterotypes_id) %>% dim

metadata_time_tmp %>%
  mutate(days_delta_bins = cut(days_delta, breaks = c(-1,60*60*24*7,120*24*60*60,365*60*60*24,10000*60*60*24))) %>%
  ggplot() + geom_histogram(aes(x=days_delta/(24*60*60), fill=c(Enterotypes_id_before == Enterotypes_id)), position = "fill", breaks = c(-1,7,30,365,1000))
  
metadata_time_tmp %>%
  mutate(days_delta_bins = cut(days_delta, breaks = c(-1,60*60*24*7,120*24*60*60,365*60*60*24,10000*60*60*24))) %>%
ggplot() + geom_bar(aes(x=days_delta_bins, fill=c(Enterotypes_id_before == Enterotypes_id)), position="fill") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_y_continuous(labels = scales::percent) + scale_fill_brewer("same partitions", type="qual") +
  facet_wrap(~branches_before) + xlab("time range between two samples") + ylab("Samples %") + scale_x_discrete(labels=c("week","4 months", "4 to 12 months", "> 12 months"))


metadata_time_tmp %>%
  mutate(days_delta_bins = cut(days_delta, breaks = c(-1,60*60*24*7,120*24*60*60,365*60*60*24,10000*60*60*24))) %>%
ggplot() + geom_bar(aes(x=days_delta_bins, fill=c(Enterotypes_id_before == Enterotypes_id)), position="fill") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_y_continuous(labels = scales::percent) + scale_fill_brewer("same partitions", type="qual") +
  xlab("time range between two samples") + ylab("Samples %") + scale_x_discrete(labels=c("week","4 months", "4 to 12 months", "> 12 months")) +
  cowplot::theme_cowplot()




```




### F B ratio

```{r}

genus %>%
  filter(taxa %in% c(f_GG,b_GG)) %>%
  tibble::column_to_rownames("taxa") %>%
  t %>%
  as.data.frame() %>%
  dplyr::rename(Feacalibacterium=2,Bacteroides=1) %>%
  mutate(ratio=Feacalibacterium/Bacteroides) -> f_b_ratio

# metadata %>%
#   filter(SAMPLE_TYPE == "Stool") %>%
#   select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
#   mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
#   merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
#   merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
#   filter(set != "outliers") %>%
#   filter(Enterotypes_id != 19) %>%
#   group_by(HOST_SUBJECT_ID) %>%
#   mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
#   filter(n>1) %>%
#   
#   mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
#   group_by(HOST_SUBJECT_ID) %>%
#   arrange(HOST_SUBJECT_ID, days) %>%
#   mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>%
#   filter(Enterotypes_id %in% c(2,6)) %>%
#   ggplot() + geom_line(aes(x=days,y=shannon,group=HOST_SUBJECT_ID, col=as.character(Enterotypes_id))) 
  

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
  merge(f_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  #filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  
  
  filter(days == 0 | days > 60*60*24) %>%
  
  
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>%
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(SAMPLE_NAME, HOST_SUBJECT_ID, days, sample_order, branches, Enterotypes_id, shannon, ratio) %>%
  mutate(Enterotypes_id = Enterotypes_id %>% as.character ) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  mutate(same_branches_lag = ifelse(branches == lag(branches), "yes","no"), 
         branches_before=lag(branches), days_delta= days - lag(days), 
         Enterotypes_id_before = lag(Enterotypes_id %>% as.character),
         shannon_before = lag(shannon),
         ratio_before = lag(ratio)) %>%
  filter(sample_order >1) %>%
  mutate(branches_pairs=paste0(branches_before,"-",branches)) %>%
  #filter(Enterotypes_id %in% c(2,6), Enterotypes_id_before %in% c(2,6)) %>%
  ungroup() %>%
  select(SAMPLE_NAME,Enterotypes_id,shannon,ratio, Enterotypes_id_before,shannon_before, ratio_before, branches) %>%
  mutate(switch=paste(Enterotypes_id,Enterotypes_id_before)) -> df



df %>%
  filter(branches=="Bacteroides DMM types") %>%
  ggplot() + 
  geom_density(aes(x=ratio)) + scale_x_continuous(trans="log2") +
  geom_vline(xintercept = 1/4)


genus %>%
  filter(taxa %in% c(f_GG,b_GG)) %>%
  tibble::column_to_rownames("taxa") %>%
  t %>%
  as.data.frame() %>%
  dplyr::rename(Feacalibacterium=2,Bacteroides=1) %>%
  mutate(ratio=(Feacalibacterium+1)/(Bacteroides+1)) -> f_b_ratio

frac_fun=function(x) 1/x

# f_b_ratio %>%
#   merge(enterotypes,., by.y="row.names", by.x="sample_name") %>%
#   filter(set != "outliers") %>%
#   filter(value>0.80) %>%
#   mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
#                               Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
#                               Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
#                               Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
#                               TRUE ~ "outliers")
#          ) %>%
#   filter(branches=="Bacteroides DMM types") %>%
#   ggplot() + 
#   geom_density(aes(x=ratio)) + scale_x_continuous(trans="log2") +
#   geom_vline(xintercept = 1/4)

f_b_ratio %>%
  merge(enterotypes,., by.y="row.names", by.x="sample_name") %>%
  filter(set != "outliers") %>%
  #filter(value>0.80) %>%
  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  filter(branches=="Bacteroides DMM types") %>% 
  #pull(ratio) %>% log2() %>% microbiome::bimodality(method = "Sarle.finite.sample", bs.iter=100, verbose=TRUE)
  ggplot() + geom_density(aes(x=ratio)) + 
   scale_x_continuous(trans="log2", labels=scales::trans_format("frac_fun",scales::label_math(expr = 1/.x, format = force))) +
  #geom_vline(xintercept = 1/5) + 
  cowplot::theme_cowplot() +
  xlab("Faecalibacterium Bacteroides ratio\nwithin Bacteroides enriched branch") -> p_fprau_density



f_b_ratio %>%
  merge(enterotypes,., by.y="row.names", by.x="sample_name") %>%
  filter(set != "outliers") %>%
  #filter(value>0.80) %>%
  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  filter(branches=="Bacteroides DMM types") %>% 
  mutate(Enterotypes_id = Enterotypes_id %>% as.character) %>%
  merge(enterotypes_time_series_stability, by="Enterotypes_id") %>%
  mutate(Enterotypes_id = Enterotypes_id %>% forcats::fct_reorder(stability)) %>%
  group_by(Enterotypes_id) %>%
  mutate(stability = median(stability)) %>%
  #pull(ratio) %>% log2() %>% microbiome::bimodality(method = "Sarle.finite.sample", bs.iter=100, verbose=TRUE)
  ggplot() + geom_boxplot(aes(x=ratio,y=Enterotypes_id, fill=stability)) +
  scale_x_continuous(trans="log2", labels=scales::trans_format("frac_fun",scales::label_math(expr = 1/.x, format = force))) +
  scale_fill_continuous(type="viridis") +
  #geom_vline(xintercept = 1/5) + 
  cowplot::theme_cowplot() +
  ylab("Bacteroides DMM types") +
  xlab("Faecalibacterium Bacteroides ratio") -> p_fprau_partition


p_fprau_density/p_fprau_partition

f_b_ratio %>%
  merge(enterotypes,., by.y="row.names", by.x="sample_name") %>%
  filter(set != "outliers") %>%
  #filter(value>0.80) %>%
  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  filter(branches=="Bacteroides DMM types") %>% 
  pull(ratio) %>% median

```


```{r}

f_b_ratio %>%
  merge(enterotypes,., by.y="row.names", by.x="sample_name") %>%
  filter(set != "outliers") %>%
  #filter(value>0.80) %>%
  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  filter(branches=="Bacteroides DMM types") %>% 
  pull(ratio) %>%  potential_analysis(x, bs.iter = 10)
  ggplot() + geom_density(aes(x=ratio, color=value>0.80)) + scale_x_continuous(trans="log2")






```



### prevotella bacteroides ratio

```{r}


f_GG = "k__Bacteria;p__Firmicutes;c__Clostridia;o__Clostridiales;f__Ruminococcaceae;g__Faecalibacterium"
b_GG = "k__Bacteria;p__Bacteroidetes;c__Bacteroidia;o__Bacteroidales;f__Bacteroidaceae;g__Bacteroides"
p_GG = "k__Bacteria;p__Bacteroidetes;c__Bacteroidia;o__Bacteroidales;f__Prevotellaceae;g__Prevotella"

genus %>%
  filter(taxa %in% c(b_GG,p_GG)) %>%
  tibble::column_to_rownames("taxa") %>%
  t %>%
  as.data.frame() %>%
  dplyr::rename(Prevotella=2,Bacteroides=1) %>%
  mutate(ratio=(Prevotella+1)/(Bacteroides+1)) -> p_b_ratio


p_b_ratio %>%
  merge(enterotypes,., by.y="row.names", by.x="sample_name") %>%
  filter(set != "outliers") %>%
  #filter(value>0.80) %>%
  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  filter(branches=="Prevotella DMM types") %>% 
  #pull(ratio) %>% log2() %>% magrittr::add(100) %>% diptest::dip()
  ggplot() + geom_density(aes(x=ratio)) + scale_x_continuous(trans="log2") +
  geom_vline(xintercept = 4) + cowplot::theme_cowplot() +
  xlab("Prevotella Bacteroides ratio\nwithin Prevotella enriched branch")



p_b_ratio %>%
  merge(enterotypes,., by.y="row.names", by.x="sample_name") %>%
  filter(set != "outliers") %>%
  #filter(value>0.80) %>%
  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  filter(branches=="Prevotella DMM types") %>% 
  #pull(ratio) %>% log2 %>% diptest::dip.test()
  ggplot() + geom_density(aes(x=ratio)) + scale_x_continuous(trans="log2") +
  geom_vline(xintercept = 3) + cowplot::theme_cowplot() +
  xlab("Prevotella Bacteroides ratio\nwithin Bacteroides enriched branch") -> p_prevotella_density


 p_b_ratio %>%
  merge(enterotypes,., by.y="row.names", by.x="sample_name") %>%
  filter(set != "outliers") %>%
  #filter(value>0.80) %>%
  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  filter(branches=="Prevotella DMM types") %>% 
  mutate(Enterotypes_id = Enterotypes_id %>% as.character) %>%
  merge(enterotypes_time_series_stability, by="Enterotypes_id") %>%
  mutate(Enterotypes_id = Enterotypes_id %>% forcats::fct_reorder(stability)) %>%
  group_by(Enterotypes_id) %>%
  mutate(stability = median(stability)) %>%
   ggplot() + geom_boxplot(aes(x=ratio,y=Enterotypes_id, fill=stability)) +
  scale_x_continuous(trans="log2") +
  scale_fill_continuous(type="viridis") +
  geom_vline(xintercept = 3) + cowplot::theme_cowplot() +
  xlab("Prevotella Bacteroides ratio") +
   ylab("Prevotella DMM types") -> p_prevotella_partition
  
 
 
 
p_prevotella_density / p_prevotella_partition
 
  p_b_ratio %>%
  merge(enterotypes,., by.y="row.names", by.x="sample_name") %>%
  filter(set != "outliers") %>%
  #filter(value>0.80) %>%
  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  filter(branches=="Prevotella DMM types") %>% pull(ratio) %>% median
    
  
```

## f/b p/b ratio figure
```{r fig.height=6, fig.width=10}

p_fprau_density / p_fprau_partition|p_prevotella_density / p_prevotella_partition

```


## M14 M18



```{r}

#compute prevotella/bacteroides ratio and merge

f_GG = "k__Bacteria;p__Firmicutes;c__Clostridia;o__Clostridiales;f__Ruminococcaceae;g__Faecalibacterium"
b_GG = "k__Bacteria;p__Bacteroidetes;c__Bacteroidia;o__Bacteroidales;f__Bacteroidaceae;g__Bacteroides"
p_GG = "k__Bacteria;p__Bacteroidetes;c__Bacteroidia;o__Bacteroidales;f__Prevotellaceae;g__Prevotella"


genus %>%
  filter(taxa %in% c(b_GG,p_GG)) %>%
  tibble::column_to_rownames("taxa") %>%
  t %>%
  as.data.frame() %>%
  dplyr::rename(Prevotella=2,Bacteroides=1) %>%
  mutate(ratio=(Prevotella+1)/(Bacteroides+1)) -> p_b_ratio


# metadata %>%
#   filter(SAMPLE_TYPE == "Stool") %>%
#   select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
#   mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
#   merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
#   merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
#   filter(set != "outliers") %>%
#   filter(Enterotypes_id != 19) %>%
#   group_by(HOST_SUBJECT_ID) %>%
#   mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
#   filter(n>1) %>%
#   
#   mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
#   group_by(HOST_SUBJECT_ID) %>%
#   arrange(HOST_SUBJECT_ID, days) %>%
#   mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>%
#   filter(Enterotypes_id %in% c(2,6)) %>%
#   ggplot() + geom_line(aes(x=days,y=shannon,group=HOST_SUBJECT_ID, col=as.character(Enterotypes_id))) 
  

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
  merge(p_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  
  
  filter(days == 0 | days > 60*60*24) %>%
  
  
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>%
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(SAMPLE_NAME, HOST_SUBJECT_ID, days, sample_order, branches, Enterotypes_id, shannon, ratio) %>%
  mutate(Enterotypes_id = Enterotypes_id %>% as.character ) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  mutate(same_branches_lag = ifelse(branches == lag(branches), "yes","no"), 
         branches_before=lag(branches), days_delta= days - lag(days), 
         Enterotypes_id_before = lag(Enterotypes_id %>% as.character),
         shannon_before = lag(shannon),
         ratio_before = lag(ratio)) %>%
  filter(sample_order >1) %>%
  mutate(branches_pairs=paste0(branches_before,"-",branches)) %>%
  filter(Enterotypes_id %in% c(14,18), Enterotypes_id_before %in% c(14,18)) %>%
  ungroup() %>%
  select(SAMPLE_NAME,Enterotypes_id,shannon,ratio, Enterotypes_id_before,shannon_before, ratio_before) %>%
  mutate(switch=paste(Enterotypes_id,Enterotypes_id_before)) -> df

df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  ggplot() + geom_boxplot(aes(x=switch,y=delta_ratio)) + 
  ylab("Faecalibacterium/Bacteroides\nratio variation") + 
  xlab("") + cowplot::theme_cowplot() + 
  scale_x_discrete(label=c("within\npartition M14","between\nfrom M14 to M18","between\nfrom M14 to M18","within\npartition M18")) -> fig5H

fig5H

df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  with(.,pairwise.wilcox.test(delta_ratio,switch, data=.))


rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(ratio)) %>%
  mutate(stable = ifelse(switch %in% c("14 14","18 18"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("14 14","14 18"), "M14","M18")  ) %>%
  #arrange(switch) %>%
  ggplot() + geom_line(aes(x=ratio,y=SAMPLE_NAME, group=SAMPLE_NAME, col=stable))  + theme(axis.text.y = element_blank()) + scale_x_continuous(trans = "log2") + 
  #facet_wrap(~switch, ncol=1, scale="free_y") +
  cowplot::theme_cowplot() +
  ylab("AGP participants") + xlab("Faecalibacterium/\nBacteroides ratio") +
  scale_color_manual("", values=c("black","red"), label=c("stable","unstable")) +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) + 
  facet_grid(start_partition~., scales = "free_y")


rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(shannon)) %>%
  mutate(stable = ifelse(switch %in% c("14 14","18 18"), "stable","unstable")  ) %>%
  #filter(stable == "stable") %>%
  ggplot() + 
  geom_point(aes(x=ratio,y=shannon,col=switch))+ 
  geom_line(aes(x=ratio,y=shannon,group=SAMPLE_NAME ,col=switch)) +
  scale_x_continuous(trans = "log2") + facet_wrap(~stable)




df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  merge(p_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(Enterotypes_id%>%as.numeric)) %>%
  ggplot() + geom_density(aes(x=ratio, fill=switch), alpha=0.5)  + theme(axis.text.y = element_blank()) + scale_x_continuous(trans = "log2")

df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  merge(p_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(Enterotypes_id%>%as.numeric)) %>%
  ggplot() + 
  #geom_density(aes(x=ratio), alpha=0.5)  + 
  geom_density(aes(x=ratio, color=switch), alpha=0.5)  +
  cowplot::theme_cowplot() +
  theme(axis.text.y = element_blank()) + 
  scale_x_continuous(trans = "log2")

# df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
#   filter(switch %in% c("2 2", "2 6")) %>%
#   merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
#   reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
#   ggplot() + geom_boxplot(aes(x=switch, y=value)) + facet_wrap(~variable, scale="free")


df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("14 14", "14 18")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
  group_by(variable) %>%
  tidyr::nest()  %>% 
  mutate(wilcox_test=purrr::map(data,~wilcox.test(.x$value~.x$switch)),
        tidy=purrr::map(wilcox_test, broom::tidy)) %>% 
      tidyr::unnest(tidy,.drop=TRUE) %>%
  arrange(p.value) %>%
  ungroup() %>%
  #mutate(p.value=p.adjust(p.value, method="fdr")) %>%
  filter(p.value<0.05) %>% select(variable,p.value) %>% write.csv2(file="metadata_link_1414vs1418.csv")


df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("18 18", "18 14")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
  group_by(variable) %>%
  tidyr::nest()  %>% 
  mutate(wilcox_test=purrr::map(data,~wilcox.test(.x$value~.x$switch)),
        tidy=purrr::map(wilcox_test, broom::tidy)) %>% 
      tidyr::unnest(tidy,.drop=TRUE) %>%
  arrange(p.value) %>%
  ungroup() %>%
  #mutate(p.value=p.adjust(p.value, method="fdr"))%>%
  filter(p.value<0.05) %>% select(variable,p.value) %>% write.csv2(file="metadata_link_1818vs1814.csv")


df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  ggplot() + geom_point(aes(x=log2(ratio_before) - log2(ratio),y=log2(shannon_before/shannon), color=switch)) +
  xlim(-4,4) + ylim(-0.5, 0.5) + cowplot::theme_cowplot() + scale_color_brewer("", type="qual", palette = 2) +
  xlab("Prevotella/Bacteroides variation") + ylab("alpha-diversity variation") -> figS11A




rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(ratio)) %>%
  mutate(stable = ifelse(switch %in% c("14 14","18 18"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("14 14","14 18"), "M14","M18")  ) %>%
  mutate(start_partition = start_partition %>% forcats::fct_reorder(ratio, .desc=TRUE)) %>%
  #arrange(switch) %>%
  ggplot() + geom_line(aes(x=ratio,y=SAMPLE_NAME, group=SAMPLE_NAME, col=stable))  + theme(axis.text.y = element_blank()) + scale_x_continuous(trans = "log2") + 
  #facet_wrap(~switch, ncol=1, scale="free_y") +
  cowplot::theme_cowplot() +
  ylab("AGP participants") + xlab("Prevotella/\nBacteroides ratio") +
  scale_color_manual("", values=c("black","red"), label=c("stable","unstable")) +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) + 
  facet_grid(start_partition~., scales = "free_y") -> fig5H_full


df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  mutate(stable = ifelse(switch %in% c("14 14","18 18"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("14 14","14 18"), "M14","M18")  ) %>%
  mutate(start_partition = start_partition %>% forcats::fct_reorder(ratio, .desc=TRUE)) %>%
  ggplot() + geom_boxplot(aes(x=start_partition,y=delta_ratio, col=stable)) + 
  ylab("Prevotella/Bacteroides\nratio variation") + 
  #scale_y_continuous(trans="log2") +
  xlab("") + cowplot::theme_cowplot() + scale_color_manual("",values=c("black","red")) -> fig5Hinset


fig5H = fig5H_full + inset_element(fig5Hinset+ylab("variation")+guides(color=FALSE), 0.65,-0.1,1,0.3, ignore_tag = TRUE)

fig5H




```


## M7 M14




```{r}

#compute prevotella/bacteroides ratio and merge

f_GG = "k__Bacteria;p__Firmicutes;c__Clostridia;o__Clostridiales;f__Ruminococcaceae;g__Faecalibacterium"
b_GG = "k__Bacteria;p__Bacteroidetes;c__Bacteroidia;o__Bacteroidales;f__Bacteroidaceae;g__Bacteroides"
p_GG = "k__Bacteria;p__Bacteroidetes;c__Bacteroidia;o__Bacteroidales;f__Prevotellaceae;g__Prevotella"


genus %>%
  filter(taxa %in% c(b_GG,p_GG)) %>%
  tibble::column_to_rownames("taxa") %>%
  t %>%
  as.data.frame() %>%
  dplyr::rename(Prevotella=2,Bacteroides=1) %>%
  mutate(ratio=(Prevotella+1)/(Bacteroides+1)) -> p_b_ratio


# metadata %>%
#   filter(SAMPLE_TYPE == "Stool") %>%
#   select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
#   mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
#   merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
#   merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
#   filter(set != "outliers") %>%
#   filter(Enterotypes_id != 19) %>%
#   group_by(HOST_SUBJECT_ID) %>%
#   mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
#   filter(n>1) %>%
#   
#   mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
#   group_by(HOST_SUBJECT_ID) %>%
#   arrange(HOST_SUBJECT_ID, days) %>%
#   mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>%
#   filter(Enterotypes_id %in% c(2,6)) %>%
#   ggplot() + geom_line(aes(x=days,y=shannon,group=HOST_SUBJECT_ID, col=as.character(Enterotypes_id))) 
  

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_datetime()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  merge(shannon, by.x="SAMPLE_NAME", by.y="row.names") %>%
  merge(p_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  
  
  filter(days == 0 | days > 60*60*24) %>%
  
  
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>%
  #arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(SAMPLE_NAME, HOST_SUBJECT_ID, days, sample_order, branches, Enterotypes_id, shannon, ratio) %>%
  mutate(Enterotypes_id = Enterotypes_id %>% as.character ) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  mutate(same_branches_lag = ifelse(branches == lag(branches), "yes","no"), 
         branches_before=lag(branches), days_delta= days - lag(days), 
         Enterotypes_id_before = lag(Enterotypes_id %>% as.character),
         shannon_before = lag(shannon),
         ratio_before = lag(ratio)) %>%
  filter(sample_order >1) %>%
  mutate(branches_pairs=paste0(branches_before,"-",branches)) %>%
  filter(Enterotypes_id %in% c(14,7), Enterotypes_id_before %in% c(14,7)) %>%
  ungroup() %>%
  select(SAMPLE_NAME,Enterotypes_id,shannon,ratio, Enterotypes_id_before,shannon_before, ratio_before) %>%
  mutate(switch=paste(Enterotypes_id,Enterotypes_id_before)) -> df

df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  ggplot() + geom_boxplot(aes(x=switch,y=delta_ratio)) + 
  ylab("Prevotella/Bacteroides\nratio variation") + 
  xlab("") + cowplot::theme_cowplot() + 
  scale_x_discrete(label=c("within\npartition M14","between\nfrom M14 to M7","between\nfrom M14 to M7","within\npartition M7")) -> fig5I

fig5I

df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  with(.,pairwise.wilcox.test(delta_ratio,switch, data=.))


rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(ratio)) %>%
  mutate(stable = ifelse(switch %in% c("14 14","7 7"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("14 14","14 7"), "M14","M7")  ) %>%
  #arrange(switch) %>%
  ggplot() + geom_line(aes(x=ratio,y=SAMPLE_NAME, group=SAMPLE_NAME, col=stable))  + theme(axis.text.y = element_blank()) + scale_x_continuous(trans = "log2") + 
  #facet_wrap(~switch, ncol=1, scale="free_y") +
  cowplot::theme_cowplot() +
  ylab("AGP participants") + xlab("Faecalibacterium/\nBacteroides ratio") +
  scale_color_manual("", values=c("black","red"), label=c("stable","unstable")) +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) + 
  facet_grid(start_partition~., scales = "free_y")


rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(shannon)) %>%
  mutate(stable = ifelse(switch %in% c("14 14","7 7"), "stable","unstable")  ) %>%
  #filter(stable == "stable") %>%
  ggplot() + 
  geom_point(aes(x=ratio,y=shannon,col=switch))+ 
  geom_line(aes(x=ratio,y=shannon,group=SAMPLE_NAME ,col=switch)) +
  scale_x_continuous(trans = "log2") + facet_wrap(~stable)




df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  merge(p_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(Enterotypes_id%>%as.numeric)) %>%
  ggplot() + geom_density(aes(x=ratio, fill=switch), alpha=0.5)  + theme(axis.text.y = element_blank()) + scale_x_continuous(trans = "log2")

df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  merge(p_b_ratio, by.x="SAMPLE_NAME", by.y="row.names") %>%
  mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(Enterotypes_id%>%as.numeric)) %>%
  ggplot() + 
  #geom_density(aes(x=ratio), alpha=0.5)  + 
  geom_density(aes(x=ratio, color=switch), alpha=0.5)  +
  cowplot::theme_cowplot() +
  theme(axis.text.y = element_blank()) + 
  scale_x_continuous(trans = "log2")

# df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
#   filter(switch %in% c("2 2", "2 6")) %>%
#   merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
#   reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
#   ggplot() + geom_boxplot(aes(x=switch, y=value)) + facet_wrap(~variable, scale="free")


df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("14 14", "14 7")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
  group_by(variable) %>%
  tidyr::nest()  %>% 
  mutate(wilcox_test=purrr::map(data,~wilcox.test(.x$value~.x$switch)),
        tidy=purrr::map(wilcox_test, broom::tidy)) %>% 
      tidyr::unnest(tidy,.drop=TRUE) %>%
  arrange(p.value) %>%
  ungroup() %>%
  #mutate(p.value=p.adjust(p.value, method="fdr")) %>%
  filter(p.value<0.05) %>% select(variable,p.value) %>% write.csv2(file="metadata_link_1414vs147.csv")


df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch) %>%
  filter(switch %in% c("7 7", "7 14")) %>%
  merge(metadata_enterotypes_num %>% select(-Enterotypes_id) %>% mutate_all(as.numeric), by.x="SAMPLE_NAME", by.y="row.names") %>%
  reshape2::melt(id=c("SAMPLE_NAME","Enterotypes_id","switch")) %>%
  group_by(variable) %>%
  tidyr::nest()  %>% 
  mutate(wilcox_test=purrr::map(data,~wilcox.test(.x$value~.x$switch)),
        tidy=purrr::map(wilcox_test, broom::tidy)) %>% 
      tidyr::unnest(tidy,.drop=TRUE) %>%
  arrange(p.value) %>%
  ungroup() %>%
  #mutate(p.value=p.adjust(p.value, method="fdr"))%>%
  filter(p.value<0.05) %>% select(variable,p.value) %>% write.csv2(file="metadata_link_77vs714.csv")


df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  ggplot() + geom_point(aes(x=log2(ratio_before) - log2(ratio),y=log2(shannon_before/shannon), color=switch)) +
  xlim(-4,4) + ylim(-0.5, 0.5) + cowplot::theme_cowplot() + scale_color_brewer("", type="qual", palette = 2) +
  xlab("Prevotella/Bacteroides variation") + ylab("alpha-diversity variation") -> figS11B




rbind(df %>% select(SAMPLE_NAME,Enterotypes_id,shannon, switch, ratio) ,
      df %>% select(SAMPLE_NAME,Enterotypes_id_before,shannon_before, switch, ratio_before) %>% dplyr::rename(Enterotypes_id=Enterotypes_id_before,shannon=shannon_before, ratio=ratio_before)) %>% 
        mutate(SAMPLE_NAME = SAMPLE_NAME %>% forcats::fct_reorder(ratio)) %>%
  mutate(stable = ifelse(switch %in% c("14 14","7 7"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("14 14","14 7"), "M14","M7")  ) %>%
  mutate(start_partition = start_partition %>% forcats::fct_reorder(ratio, .desc=TRUE)) %>%
  #arrange(switch) %>%
  ggplot() + geom_line(aes(x=ratio,y=SAMPLE_NAME, group=SAMPLE_NAME, col=stable))  + theme(axis.text.y = element_blank()) + scale_x_continuous(trans = "log2") + 
  #facet_wrap(~switch, ncol=1, scale="free_y") +
  cowplot::theme_cowplot() +
  ylab("AGP participants") + xlab("Prevotella/\nBacteroides ratio") +
  scale_color_manual("", values=c("black","red"), label=c("stable","unstable")) +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) + 
  facet_grid(start_partition~., scales = "free_y") -> fig5I_full


df %>%
  mutate(delta_ratio = abs(log2(ratio_before) - log2(ratio))) %>%
  mutate(stable = ifelse(switch %in% c("14 14","7 7"), "stable","unstable")  ) %>%
  mutate(start_partition = ifelse(switch %in% c("14 14","14 7"), "M14","M7")  ) %>%
  mutate(start_partition = start_partition %>% forcats::fct_reorder(ratio, .desc=TRUE)) %>%
  ggplot() + geom_boxplot(aes(x=start_partition,y=delta_ratio, col=stable)) + 
  ylab("Prevotella/Bacteroides\nratio variation") + 
  #scale_y_continuous(trans="log2") +
  xlab("") + cowplot::theme_cowplot() + scale_color_manual("",values=c("black","red")) -> fig5Iinset


fig5I = fig5I_full + inset_element(fig5Iinset+ylab("variation")+guides(color=FALSE), 0.65,-0.1,1,0.3, ignore_tag = FALSE)

fig5I




```

# Full figure



```{r fig.height=9, fig.width=16}

((fig5A) | (fig5B_full/fig5C_full)) + plot_annotation(tag_levels = "a") + plot_layout(widths = c(2,1.5))

p_fprau_density / p_fprau_partition|p_prevotella_density / p_prevotella_partition

fig5I_full




(
  (fig5A + theme(plot.tag = element_text(face = "bold"))) | 
    
  ((p_fprau_density / p_fprau_partition + ylab("Bacteroides\nDMM types")) + plot_layout(heights = c(1,2)) ) |
    
  (((p_prevotella_density + xlab("Prevotella Bacteroides ratio\nwithin Prevotella enriched branch")) / (p_prevotella_partition + ylab("Prevotella\nDMM types"))) + plot_layout(heights = c(1,2)) ) + 
    plot_layout(widths = c(4,1,1))
  
  ) /
  
(fig5B_full|fig5C_full|fig5I_full) + plot_annotation(tag_levels = "a")





```


```{r fig.height=12, fig.width=16}

fig5B_full_scaled =
fig5B_full +
  geom_vline(xintercept = 1/4) +
scale_x_continuous(trans="log2", labels=scales::trans_format("frac_fun",scales::label_math(expr = 1/.x, format = force)), limits = c(1/64,3/2))

fig5C_full_scaled = 
fig5C_full +
  geom_vline(xintercept = 1/4) +
scale_x_continuous(trans="log2", labels=scales::trans_format("frac_fun",scales::label_math(expr = 1/.x, format = force)), limits = c(1/64,3/2))

fig5J_ellispse_scaled =
fig5J_ellispse+
  xlab("F B ratio") +
  scale_x_continuous(trans="log2", labels=scales::trans_format("frac_fun",scales::label_math(expr = 1/.x, format = force)), limits = c(1/64,3/2))+
  cowplot::theme_cowplot()


fig5K_ellispse_scaled =
fig5K_ellispse+
  xlab("F B ratio") +
  scale_x_continuous(trans="log2", labels=scales::trans_format("frac_fun",scales::label_math(expr = 1/.x, format = force)), limits = c(1/64,3/2))+
  cowplot::theme_cowplot()



((((fig5A + theme(plot.tag = element_text(face = "bold"))) /fig5M_stability ) +  plot_layout(heights = c(1,1.5)) )  |

    (((fig5Binset+ylab("F B ratio variation"))/(fig5Cinset+ylab("F B ratio variation"))/plot_spacer()/plot_spacer()) + plot_layout(heights = c(0.8,0.8,1,1)) ) |
  
((fig5B_full_scaled/fig5C_full_scaled/(p_fprau_density+geom_vline(xintercept = 1/4))/(p_fprau_partition+  geom_vline(xintercept = 1/4))) + plot_layout(heights = c(1,1,0.5,1.5))  )
   #((fig5J_ellispse_scaled)/(fig5K_ellispse_scaled)/plot_spacer()/plot_spacer()) |
 
  ) + plot_layout(widths = c(1.5,0.5,1)) + plot_annotation(tag_levels = "a")
   

ggsave(file="figure_network_time_series.pdf")



(
  (
    (
      (fig5A + 
         theme(plot.tag = element_text(face = "bold"))
       ) /
        (fig5M_stability)
      ) +  
      plot_layout(heights = c(1.5,1.5)) 
    )  |
    (
      (
        (
          (fig5Binset+ylab("F B ratio variation"))/
            (fig5Cinset+ylab("F B ratio variation")) |
            (fig5B_full_scaled)/
            (fig5C_full_scaled))/
          (
            (p_fprau_density+geom_vline(xintercept = 1/4))/
              (p_fprau_partition+  geom_vline(xintercept = 1/4)) + 
              plot_layout(heights = c(1,2)) 
            ) 
        ) + 
        plot_layout(heights = c(1.5,1.25))
      )
  ) + 
  plot_layout(widths = c(1.5,1.5)) + plot_annotation(tag_levels = "a")


ggsave(file="figure_network_time_series.pdf")



```


```{r fig.height=4, fig.width=9}


fig5J_ellispse_scaled + fig5K_ellispse_scaled + plot_annotation(tag_levels = "a")

ggsave(file="figureS9_bis.pdf")

```



# bimodality and stability

```{r}

metadata %>%
  filter(SAMPLE_TYPE == "Stool") %>%
  select(HOST_SUBJECT_ID,SAMPLE_NAME, COLLECTION_TIMESTAMP) %>%
  mutate(COLLECTION_TIMESTAMP = COLLECTION_TIMESTAMP %>% lubridate::as_date()) %>%
  merge(enterotypes, by.x="SAMPLE_NAME", by.y="sample_name") %>%
  filter(set != "outliers") %>%
  filter(Enterotypes_id != 19) %>%
  group_by(HOST_SUBJECT_ID) %>%
  mutate(min_date = min(COLLECTION_TIMESTAMP), n=n()) %>%
  #filter(n>1) %>%
  
  mutate(days=COLLECTION_TIMESTAMP - min_date) %>% 
  group_by(HOST_SUBJECT_ID) %>%
  arrange(HOST_SUBJECT_ID, days) %>%
  mutate(sample_order=order(COLLECTION_TIMESTAMP)) %>% 
  

  mutate(branches = case_when(Enterotypes_id %in% c(18,14,16,17,7) ~ "Prevotella DMM types",
                              Enterotypes_id %in% c(11,15,6,8,10,3,4,2) ~ "Bacteroides DMM types",
                              Enterotypes_id %in% c(12,1,5,9) ~ "Clostridiales DMM types",
                              Enterotypes_id %in% c(13) ~ "Akkermansia DMM types",
                              TRUE ~ "outliers")
         ) %>%
  
  mutate(days_0=branches[which.min(sample_order)]) %>% 
  arrange(HOST_SUBJECT_ID)  %>% 
  #mutate(sample_order=rank(days)) %>%
  mutate(days = as.numeric(days)) %>%
  select(SAMPLE_NAME,HOST_SUBJECT_ID,days,value,Enterotypes_id,branches) %>%
  dplyr::rename(time=days,subject=HOST_SUBJECT_ID) %>% mutate(sample=SAMPLE_NAME) %>% tibble::column_to_rownames("SAMPLE_NAME")-> metadata_for_physeq


genus %>% tibble::column_to_rownames("taxa") %>% otu_table(taxa_are_rows=TRUE) -> genus_for_phyloseq

genus %>%
  select(taxa) %>%
  tidyr::separate(taxa, into=c("k","p","c","o","f","g"),remove = FALSE, sep = ";") %>%
  tibble::column_to_rownames("taxa") %>% as.matrix %>% tax_table() -> taxa_for_phyloseq


pseq=phyloseq(OTU=genus_for_phyloseq, sample_data(metadata_for_physeq), TAX=taxa_for_phyloseq )





```


```{r}



pseq=phyloseq(OTU=genus_for_phyloseq, sample_data(metadata_for_physeq), TAX=taxa_for_phyloseq )

#pseq <- pseq %>% subset_samples(value>0.80)
pseq <- pseq %>% subset_samples(Enterotypes_id %in% c("15","1"))
pseq <- microbiome::transform(pseq, "compositional")
pseq <- aggregate_rare(pseq, level="g", detection = .1/100, prevalence = 5/100)
pseq0 <- baseline(pseq)

otu_table(pseq) %>% dim

```

## intermediate stability quantification
```{r}

intermediate_stability_alr = function (x, reference.point = NULL, method = "correlation", 
    output = "scores"){
    x0 <- x
    if (length(reference.point) > 1 && output == "scores") {
        scores <- c()
        for (i in seq_len(length(reference.point))) {
            scores[[i]] <- intermediate_stability(x, reference.point = reference.point[[i]], 
                method = method, output = output)
        }
        if (ntaxa(x) > 1) {
            scores <- as.data.frame(scores, nrow = ntaxa(x))
        }
        else {
            scores <- as.data.frame(t(as.matrix(scores, ncol = length(reference.point))))
        }
        colnames(scores) <- as.character(reference.point)
        rownames(scores) <- taxa(x)
        return(scores)
    }
    x <- abundances(transform(x0, "identity"))
    b <- abundances(transform(x0, "identity"))["g__Bacteroides"]
    x = log2((x+1)/(b+1))
    meta <- sample_data(x0)
    stability <- list()
    df <- meta
    df$time <- as.numeric(as.character(df$time))
    df <- df[df$subject %in% names(which(table(df$subject) > 
        1)), ]
    spl <- split(df, as.character(df$subject))
    spl.list <- list()
    for (i in seq_len(length(spl))) {
        spl.list[[i]] <- list(spl = spl[[i]][order(spl[[i]]$time), 
            ], time.difs = diff(spl[[i]]$time))
    }
    for (tax in rownames(x)) {
        df$data <- x[tax, rownames(df)]
        stability[[tax]] <- estimate_stability(df, reference.point = reference.point, 
            method = method, spl.list)
    }
    if (output == "full") {
        return(stability)
    }
    else if (output == "scores") {
        intermediate.stability <- vapply(stability, function(x) {
            x$stability
        }, 1)
        return(intermediate.stability)
    }
}


# Here we use the (non-baseline) phyloseq object that contains time series.
intermediate.stability <- intermediate_stability_alr(pseq, output = "scores", method = "correlations") #clr transfo included

intermediate.stability %>% sort %>% round(3)
```



## bimodality quantifycation

```{r}
# Bimodality is better estimated from abundances at log scale (such as CLR)
pseq0.clr <- microbiome::transform(pseq0, "clr")

set.seed(4433)



bimodality.score <- bimodality(pseq0.clr, method = "potential_analysis",
                               bs.iter = 100, peak.threshold = 10,
                   min.density = 10)

bimodality.score %>% sort %>% round(3)

```


## Comparing bimodality and intermediate stability

```{r}

taxa <- taxa(pseq0)
df <- data.frame(group = as.character(taxa) %>% gsub("g__","",.),
intermediate.stability = intermediate.stability[taxa],
bimodality = bimodality.score[taxa])
theme_set(theme_bw(20))

df = df %>%
  mutate(group = group %>% as.character()) %>%
  mutate(label = ifelse(bimodality > 0.6 & intermediate.stability < 0, group, ''))

df %>%
  filter(bimodality > 0.6 & intermediate.stability < -0.1) %>%
  arrange(intermediate.stability)


library(ggrepel)

p <- ggplot(df,
  aes(x = intermediate.stability, y = bimodality, label = '')) + #Doesn't add labels to points
  geom_text_repel() +
  geom_point()

#Labels only those that have bimodality > 0.4 and intermediate stability < 0, adjusts the placement of labels
p <- p + geom_text(aes(label = ifelse(bimodality > 0.6 & intermediate.stability < -0.25, group, '')), vjust = "inward", hjust = "inward")

print(p)


```


## Tipping point

```{r}

# Log10 abundance for a selected taxonomic group
# Pick the most bimodal taxa as an example
#tax  <- names(which.max(bimodality.score))
tax = "g__Bacillus"

# Detect tipping points at log10 abundances
x <- abundances(microbiome::transform(pseq, "clr"))[tax,]

 f <- abundances(microbiome::transform(pseq, "identity"))[tax,]
 b <- abundances(microbiome::transform(pseq, "identity"))["g__Bacteroides",]
 x=log2((f+1)/(b+1))

# Bootstrapped potential analysis to identify potential minima
# in practice, use more bootstrap iterations
potential.minima <- potential_analysis(x, bs.iter = 10)$minima

# Same with earlywarnings package (without bootstrap ie. less robust)
# library(earlywarnings)
# res <- livpotential_ews(x)$min.points

# Identify the potential minimum locations as tipping point candidates
tipping.samples <- sapply(potential.minima, function (m) {names(which.min(abs(sort(x) - m)))})
tipping.point <- abundances(pseq)[tax, tipping.samples]
print(tipping.point)


```


```{r}
 f <- abundances(microbiome::transform(pseq, "identity"))[tax,]
 b <- abundances(microbiome::transform(pseq, "identity"))["g__Bacteroides",]
 x=log2((f+1)/(b+1))

# Illustrate the detected tipping point
plot(density(x), main = tax)
abline(v = x[tipping.samples])
hist(x, main = tax)
abline(v = x[tipping.samples])




```

```{r}

data.frame(x) %>%
  merge(sample_data(pseq), by="row.names") %>%
  filter(Enterotypes_id %in% c("15","1")) %>%
  dplyr::rename(test=x) %>%
  mutate(tip=ifelse(test < x[tipping.samples][1], "low", "high")) %>%
  with(.,xtabs(~tip+Enterotypes_id, data=.)) #%>% chisq.test()


```







## by branch


```{r}
branches = c("Bacteroides DMM types","Prevotella DMM types", "Clostridiales DMM types", "Akkermansia DMM types")
res=NULL
for(branch in branches) {
  
  set.seed(666)
  pseq=phyloseq(OTU=genus_for_phyloseq, sample_data(metadata_for_physeq), TAX=taxa_for_phyloseq )
  pseq <- pseq %>% subset_samples(value>0.80)
  pseq <- pseq %>% subset_samples(branches == branch)
  pseq <- microbiome::transform(pseq, "compositional")
  pseq <- aggregate_rare(pseq, level="g", detection = .1/100, prevalence = 5/100)
  pseq0 <- baseline(pseq)
  intermediate.stability <- intermediate_stability(pseq, output = "scores")
  pseq0.clr <- microbiome::transform(pseq0, "clr")
  bimodality.score <- bimodality(pseq0.clr, method = "potential_analysis",
                               bs.iter = 100, peak.threshold = 10,
                   min.density = 10)
  
  res=rbind(
  as_tibble(data.frame(bimodality.score,intermediate.stability, branches=branch) %>% tibble::rownames_to_column("taxa")),
  res
  )
  
}
```


```{r}
merge(res,
data.frame(bimodality_score_all=bimodality.score,intermediate_stability_all=intermediate.stability),
by.y="row.names", by.x="taxa") %>%
  filter(branches != "Akkermansia DMM types") %>%
  ggplot + geom_point(aes(x=intermediate_stability_all, y=intermediate.stability, col=branches)) +
  geom_abline(slope=1)
  

merge(res,
data.frame(bimodality_score_all=bimodality.score,intermediate_stability_all=intermediate.stability),
by.y="row.names", by.x="taxa") %>%
  filter(branches != "Akkermansia DMM types") %>%
  filter(intermediate_stability_all>0,intermediate.stability< -0.1, bimodality.score>0.6) %>%
  arrange(branches) %>% pull(taxa) %>% unique -> taxa_bistable_branch
  

merge(res,
data.frame(bimodality_score_all=bimodality.score,intermediate_stability_all=intermediate.stability),
by.y="row.names", by.x="taxa") %>%
  filter(branches != "Akkermansia DMM types") %>%
  filter(intermediate_stability_all< -0.1,intermediate.stability>0, bimodality_score_all>0.6) %>%
  arrange(branches) %>% pull(taxa) %>% unique


data.frame(bimodality_score_all=bimodality.score,intermediate_stability_all=intermediate.stability) %>%
  filter(intermediate_stability_all< -0.1, bimodality_score_all>0.6) %>%
  row.names() -> taxa_bistable_all






```



```{r}


pseq=phyloseq(OTU=genus_for_phyloseq, sample_data(metadata_for_physeq), TAX=taxa_for_phyloseq )

pseq0 <- baseline(pseq)

sample_data(pseq) %>%
  as_tibble() %>%
  mutate(Enterotypes_id = as.character(Enterotypes_id)) %>%
  group_by(subject) %>%
  arrange(subject) %>%
  mutate(n=n()) %>%
  filter(n>1) %>%
  arrange(subject,time) %>%
  mutate(sample_before = lag(sample), time_before=lag(time), Enterotypes_id_before=lag(Enterotypes_id)) %>%
  filter(!(time_before==time)) %>%
  select(subject,time,time_before,sample,sample_before,Enterotypes_id,Enterotypes_id_before) %>%
  mutate(partition_stability=ifelse(Enterotypes_id_before==Enterotypes_id,"stable","unstable")) -> metadata_time_lag
  
samples_time_series = sample_data(pseq) %>% as_tibble() %>% group_by(subject) %>% mutate(n=n()) %>% filter(n>1) %>% pull(sample)



pseq %>%
  aggregate_rare(level="g", detection = .1/100, prevalence = 5/100) %>%
  microbiome::transform("clr") %>%
  otu_table() %>%
  data.frame(check.names = FALSE) %>%
  tibble::rownames_to_column("taxa") %>%
  as_tibble() %>%
  filter(taxa %in% c(taxa_bistable_branch,taxa_bistable_all)) -> df_tmp
  
df_tmp %>% 
  select(taxa, all_of(samples_time_series)) %>%
  reshape2::melt() -> taxa_time_melt


metadata_time_lag %>%
  merge(taxa_time_melt, by.x="sample", by.y="variable") %>%
  merge(taxa_time_melt, by.x=c("taxa","sample_before"), by.y=c("taxa","variable")) -> metadata_taxa_time_lag




```




```{r fig.height=7, fig.width=7}
metadata_taxa_time_lag %>%
  filter(taxa %in% c("g__Lactobacillus","g__Desulfovibrio")) %>%
  mutate(value_abs=ifelse(value.x<value.y, value.x, value.y)) %>%
  mutate(delta = abs(value.x-value.y)) %>%
  mutate(switch = paste(Enterotypes_id_before,Enterotypes_id, sep="_")) %>%
  group_by(switch) %>%
  mutate(n_switch = n()) %>%
  filter(n_switch > 15) %>%
  ungroup() %>%
  group_by(taxa) %>%
  mutate(sample = sample %>% forcats::fct_reorder(value_abs, .desc=TRUE)) %>%
  ggplot() + geom_segment(aes(x=value.x, xend=value.y,y=sample,yend=sample, col=partition_stability)) + 
  facet_grid(switch~taxa, scales = "free") + 
  scale_color_manual(values=c("grey","pink")) +
  cowplot::theme_cowplot() +
  theme(axis.text.y = element_blank())


metadata_taxa_time_lag %>%
  filter(taxa %in% c("g__Methanobrevibacter","g__Desulfovibrio")) %>%
  mutate(value_abs=ifelse(value.x<value.y, value.x, value.y)) %>%
  mutate(delta = abs((value.x+value.y)/2)) %>%
  mutate(switch = paste(Enterotypes_id_before,Enterotypes_id, sep="_")) %>%
  group_by(switch) %>%
  mutate(n_switch = n()) %>%
  filter(n_switch > 6) %>%
  ungroup() %>%
  ggplot() + geom_boxplot(aes(x=switch,y=delta)) + 
  facet_grid(partition_stability~taxa, scale="free", space = "free_y" ) +
  coord_flip()


metadata_taxa_time_lag %>%
  filter(taxa %in% c("g__Prevotella","g__Odoribacter")) %>%
  mutate(value_abs=ifelse(value.x<value.y, value.x, value.y)) %>%
  mutate(value_m = ((value.x+value.y)/2)) %>%
  mutate(delta = abs(value.x-value.y)) %>%
  mutate(switch = paste(Enterotypes_id_before,Enterotypes_id, sep="_")) %>%
  group_by(switch) %>%
  mutate(n_switch = n()) %>%
  #filter(n_switch > 15) %>%
  ungroup() %>%
  #filter(partition_stability=="unstable") %>%
  ggplot() + geom_point(aes(x=value_m,y=delta,col=partition_stability)) + 
  facet_grid(partition_stability~taxa)


metadata_taxa_time_lag %>%
  filter(taxa %in% c("g__Prevotella","g__Bacillus")) %>%
  mutate(value_abs=ifelse(value.x<value.y, value.x, value.y)) %>%
  mutate(value_m = abs((value.x+value.y)/2)) %>%
  mutate(delta = abs(value.x-value.y)) %>%
  mutate(switch = paste(Enterotypes_id_before,Enterotypes_id, sep="_")) %>%
  group_by(switch) %>%
  mutate(n_switch = n()) %>%
  #filter(n_switch > 15) %>%
  ungroup()
```


```{r fig.height=7, fig.width=7}
res=NULL

for(i in 1:17){
  
  for(j in i:18) {
  
    if(i==j) next
    
i=as.character(i)    
j=as.character(j)

switch=paste(i,j, sep="_")
    
metadata_taxa_time_lag %>%
  #filter(taxa %in% c("g__Prevotella","g__Odoribacter")) %>%
  filter(Enterotypes_id %in% c(i,j), Enterotypes_id_before %in% c(i,j)) %>%
  mutate(delta= abs(value.x-value.y)) -> tmp1

if(length(names(table(tmp1$partition_stability))) == 1) {next}

tmp1 %>%
  group_by(taxa) %>%
  do(with(.,wilcox.test(delta~partition_stability, data=.) %>% broom::tidy())) %>%
  filter(p.value<0.05) %>%
  mutate(switch=switch) -> tmp2
  
res=rbind(tmp2,res)

  
  } }

res %>% select(taxa,switch)
```


```{r fig.height=7, fig.width=7}
res2=NULL

for(i in 1:17){
  
  for(j in i:18) {
  
    if(i==j) next
    
i=as.character(i)    
j=as.character(j)

switch=paste(i,j, sep="_")

metadata_taxa_time_lag %>%
  #filter(taxa %in% c("g__Prevotella","g__Odoribacter")) %>%
  filter(Enterotypes_id %in% c(i,j), Enterotypes_id_before %in% c(i,j)) %>%
  mutate(value_m=(value.x+value.y/2)) %>%
  #filter(partition_stability == "unstable") %>%
  group_by(taxa) %>%
  do(with(.,wilcox.test(value.x~Enterotypes_id, data=.) %>% broom::tidy())) %>%
  filter(p.value<0.05) %>%
  mutate(switch=switch) -> tmp



res2=rbind(tmp,res2)

  
  } }

res2




```

```{r}

merge(res %>% select(taxa, switch),
res2 %>% select(taxa, switch), by=c("taxa","switch"))



```



```{r fig.height=7, fig.width=7}
metadata_taxa_time_lag %>%
  #filter(taxa %in% c("g__Prevotella","g__Odoribacter")) %>%
  filter(Enterotypes_id %in% c("3","5"), Enterotypes_id_before %in% c("3","5")) %>%
  mutate(value_m=(value.x+value.y/2)) %>%
  #filter(partition_stability == "unstable") %>%
  group_by(taxa) %>%
  do(with(.,wilcox.test(value.x~Enterotypes_id, data=.) %>% broom::tidy())) %>%
  filter(p.value<0.05)




metadata_taxa_time_lag %>%
  filter(taxa %in% c("g__Prevotella","g__Odoribacter")) %>%
  filter(Enterotypes_id %in% c("3","5"), Enterotypes_id_before %in% c("3","5")) %>%
  filter(partition_stability == "unstable") %>%
  mutate(value_m=(value.x+value.y/2)) %>%
  ggplot() + ggforce::geom_sina(aes(x=Enterotypes_id, y=value_m))




metadata_taxa_time_lag %>%
  filter(taxa %in% c("g__Akkermansia")) %>%
  #filter(Enterotypes_id %in% c("1","5","9","12"), Enterotypes_id_before %in% c("1","5","9","12")) %>%
  mutate(switch = paste(Enterotypes_id_before,Enterotypes_id, sep="_")) %>%
  mutate(value_m=(value.x+value.y/2)) %>%
  mutate(sample = sample %>% forcats::fct_reorder(value_m, .desc=TRUE)) %>%
  #filter(partition_stability=="stable") %>%
  ggplot() + geom_segment(aes(x=value.x, xend=value.y,y=sample,yend=sample)) + 
  facet_grid(partition_stability~taxa, scales = "free") + 
  #scale_color_manual(values=c("grey","pink")) +
  cowplot::theme_cowplot() +
  theme(axis.text.y = element_blank())


```


